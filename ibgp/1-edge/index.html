<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        <link rel="canonical" href="https://bgplabs.net/ibgp/1-edge/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Establish an IBGP Session &#171; BGP Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BGP Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Home</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../2-labs-by-technology/" class="dropdown-item">Labs by BGP Attributes and Technologies</a>
</li>
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../99-about/" class="dropdown-item">About the Project</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Installation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
<li>
    <a href="../../4-codespaces/" class="dropdown-item">Use GitHub Codespaces</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Custom Lab Infrastructure</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../external/" class="dropdown-item">Manual Setup</a>
</li>
            
<li>
    <a href="../../external/4-router/" class="dropdown-item">Small (4-Router) Lab Topology</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Deploy BGP</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../basic/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Setting Up BGP</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/0-frrouting/" class="dropdown-item">Configuring Cumulus Linux and FRRouting</a>
</li>
            
<li>
    <a href="../../basic/1-session/" class="dropdown-item">Configure a Single EBGP Session</a>
</li>
            
<li>
    <a href="../../basic/2-multihomed/" class="dropdown-item">Configure Multiple EBGP Sessions</a>
</li>
            
<li>
    <a href="../../basic/3-originate/" class="dropdown-item">Advertise IPv4 Prefixes to BGP Neighbors</a>
</li>
            
<li>
    <a href="../../basic/4-ipv6/" class="dropdown-item">Configure BGP for IPv6</a>
</li>
            
<li>
    <a href="../../basic/5-redistribute/" class="dropdown-item">Redistribute IGP Information Into BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Protecting BGP Sessions</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/6-protect/" class="dropdown-item">MD5 Passwords and GTSM</a>
</li>
            
<li>
    <a href="../../basic/9-ao/" class="dropdown-item">TCP Autentication Option (TCP-AO)</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">BGP in Larger Networks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Establish an IBGP Session</a>
</li>
            
<li>
    <a href="../2-transit/" class="dropdown-item">Build a Transit Network with IBGP</a>
</li>
            
<li>
    <a href="../3-rr/" class="dropdown-item">Use BGP Route Reflectors</a>
</li>
            
<li>
    <a href="../../session/6-templates/" class="dropdown-item">BGP Session Templates</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
            
<li>
    <a href="../../session/9-dynamic/" class="dropdown-item">Dynamic BGP Peers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Manipulate AS Path</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../session/1-allowas_in/" class="dropdown-item">Reuse a BGP AS Number Across Multiple Sites</a>
</li>
            
<li>
    <a href="../../session/2-asoverride/" class="dropdown-item">Fix AS-Path in Environments Reusing BGP AS Numbers</a>
</li>
            
<li>
    <a href="../../session/3-localas/" class="dropdown-item">Use Multiple AS Numbers on the Same Router</a>
</li>
            
<li>
    <a href="../../session/4-removeprivate/" class="dropdown-item">Remove Private BGP AS Numbers from the AS Path</a>
</li>
            
<li>
    <a href="../../session/5-routeserver/" class="dropdown-item">BGP Route Server in an Internet Exchange Point</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Load Balancing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lb/1-ebgp/" class="dropdown-item">Load Balancing across External BGP Paths</a>
</li>
            
<li>
    <a href="../../lb/2-dmz-bw/" class="dropdown-item">EBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/3-ibgp/" class="dropdown-item">IBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/4-ibgp-add-path/" class="dropdown-item">IBGP Load Balancing with BGP Additional Paths</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Other Useful Topics</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/7-bfd/" class="dropdown-item">Use BGP Timers and BFD to Speed Up BGP Convergence</a>
</li>
            
<li>
    <a href="../../basic/8-aggregate/" class="dropdown-item">BGP Route Aggregation</a>
</li>
            
<li>
    <a href="../../basic/c-default-route/" class="dropdown-item">Advertise Default Route in BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
            
<li>
    <a href="../../basic/e-ebgp-multihop/" class="dropdown-item">Running EBGP Across a Firewall</a>
</li>
            
<li>
    <a href="../../session/8-passive/" class="dropdown-item">Passive BGP Sessions</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Routing Policies</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../policy/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Route Filters</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/2-stop-transit/" class="dropdown-item">Filter Transit Routes</a>
</li>
            
<li>
    <a href="../../policy/3-prefix/" class="dropdown-item">Filter Advertised Prefixes</a>
</li>
            
<li>
    <a href="../../policy/4-reduce/" class="dropdown-item">Minimize the Size of Your BGP Table</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
            
<li>
    <a href="../../policy/d-no-export/" class="dropdown-item">Using No-Export Community to Filter Transit Routes</a>
</li>
            
<li>
    <a href="../../policy/f-orf/" class="dropdown-item">Use Outbound Route Filters (ORF) for IP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Outgoing (Egress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/1-weights/" class="dropdown-item">Select Preferred EBGP Peer with Weights</a>
</li>
            
<li>
    <a href="../../policy/5-local-preference/" class="dropdown-item">Select Preferred Uplink with BGP Local Preference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Incoming (Ingress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/6-med/" class="dropdown-item">Use MED to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../../policy/7-prepend/" class="dropdown-item">Use AS-Path Prepending to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../../policy/8-community-attach/" class="dropdown-item">Attach BGP Communities to Outgoing BGP Updates</a>
</li>
            
<li>
    <a href="../../policy/e-wedgies/" class="dropdown-item">Resolve BGP Wedgies</a>
</li>
            
<li>
    <a href="../../policy/b-disaggregate/" class="dropdown-item">Use Disaggregated Prefixes to Select the Primary Link</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">More Complex Routing Policies</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/9-community-use/" class="dropdown-item">Use BGP Communities in Routing Policies</a>
</li>
            
<li>
    <a href="../../policy/a-locpref-route-map/" class="dropdown-item">BGP Local Preference in a Complex Routing Policy</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Challenges</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../challenge/03-graceful-shutdown/" class="dropdown-item">BGP Graceful Shutdown</a>
</li>
                                    
<li>
    <a href="../../challenge/04-block-fat-fingers/" class="dropdown-item">Stop the Propagation of Configuration Errors</a>
</li>
                                    
<li>
    <a href="../../challenge/20-merge-as/" class="dropdown-item">Merge Networks Using Different BGP AS Numbers</a>
</li>
                                    
<li>
    <a href="../../challenge/30-reduce-fib/" class="dropdown-item">Minimize the Forwarding Table on BGP Routers</a>
</li>
                                    
<li>
    <a href="../../challenge/40-mpls-core/" class="dropdown-item">BGP-Free Core in a Transit Network</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Upcoming</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../challenge/01-bird-rr/" class="dropdown-item">Using BIRD BGP Daemon as a BGP Route Reflector</a>
</li>
                                    
<li>
    <a href="../../challenge/02-anycast/" class="dropdown-item">Implement Anycast Services with BGP</a>
</li>
                                    
<li>
    <a href="../../challenge/05-ebgp-dc/" class="dropdown-item">EBGP-Only Data Center Design</a>
</li>
                                    
<li>
    <a href="../../challenge/21-loopback-vrf/" class="dropdown-item">Run EBGP Between VRF Instances on a Single Router</a>
</li>
                                    
<li>
    <a href="../../challenge/22-bgp-ha-protocol/" class="dropdown-item">BGP as a High Availability Protocol</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../basic/b-max-prefix/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../2-transit/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>

                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
  <div class="navbar-header">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
          <span class="fa fa-angle-down"></span>
      </button>
  </div>

  
  
  
  
  
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary"  style="margin-bottom: 1em;">
      <ul class="nav flex-column">
          
      <li class="nav-item" data-level="1"><a href="#establish-an-ibgp-session-between-wan-edge-routers" class="nav-link">Establish an IBGP Session Between WAN Edge Routers</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="2"><a href="#existing-lab-configuration" class="nav-link">Existing Lab Configuration</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#bgp-configuration" class="nav-link">BGP Configuration</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#ospf-configuration" class="nav-link">OSPF Configuration</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#start-the-lab" class="nav-link">Start the Lab</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#why-do-we-need-ibgp" class="nav-link">Why Do We Need IBGP?</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#establish-ibgp-session" class="nav-link">Establish IBGP Session</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#fix-the-source-ip-address-of-the-ibgp-session" class="nav-link">Fix the Source IP Address of the IBGP Session</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#fix-the-bgp-next-hop-of-ibgp-prefixes" class="nav-link">Fix the BGP Next Hop of IBGP Prefixes</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#automated-verification" class="nav-link">Automated Verification</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#req" class="nav-link">Device Requirements</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-wiring" class="nav-link">Lab Wiring</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-addressing" class="nav-link">Lab Addressing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
        </ul>
      </li>
      </ul>
    </div>
  
  
  
  
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="establish-an-ibgp-session-between-wan-edge-routers">Establish an IBGP Session Between WAN Edge Routers</h1>
<p>The <em><a href="../../basic/#simple">Setting Up BGP</a></em> lab exercises covered the simplest possible scenario: your site has a single WAN edge router running BGP with one or more upstream Internet Service Providers (ISPs). That scenario is implausible &ndash; an organization investing in its own IP address space and AS number usually does that to achieve higher resilience of its Internet connectivity, and having a single WAN edge router is not good enough for that.</p>
<p>In this lab exercise, you&rsquo;ll build a more realistic solution: your organization uses two WAN edge routers running BGP with two upstream ISPs.</p>
<p><img alt="Lab topology" src="../topology-ibgp.png" /></p>
<p>Most organizations want to optimize the utilization of their (still relatively expensive) WAN links. To do so, you&rsquo;ll have to ensure that all your routers reach the destinations in ISP-1 via the R1-X1 uplink (and similarly for ISP-2).</p>
<h2 id="existing-lab-configuration">Existing Lab Configuration</h2>
<p>When starting the lab with <em>netlab</em>, you&rsquo;ll get a preconfigured lab with EBGP sessions between the three autonomous systems and OSPF running between R1 and R2.</p>
<h3 id="bgp-configuration">BGP Configuration</h3>
<p>The routers in your lab use the following BGP AS numbers. Each upstream router advertises an IPv4 prefix; your routers advertise the IPv4 prefix of the LAN subnet connecting them.</p>
<table>
<thead>
<tr>
<th>Node/ASN</th>
<th style="text-align: right;">Router ID</th>
<th style="text-align: right;">Advertised prefixes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AS65000</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>r1</td>
<td style="text-align: right;">10.0.0.1</td>
<td style="text-align: right;">10.0.100.0/24</td>
</tr>
<tr>
<td>r2</td>
<td style="text-align: right;">10.0.0.2</td>
<td style="text-align: right;">10.0.100.0/24</td>
</tr>
<tr>
<td><strong>AS65100</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>x1</td>
<td style="text-align: right;">192.168.100.1</td>
<td style="text-align: right;">192.168.100.0/24</td>
</tr>
<tr>
<td><strong>AS65101</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>x2</td>
<td style="text-align: right;">172.16.101.1</td>
<td style="text-align: right;">172.16.101.0/24</td>
</tr>
</tbody>
</table>
<p><em>netlab</em> configures these EBGP sessions when starting the lab; if you&rsquo;re using some other lab infrastructure, you&rsquo;ll have to configure EBGP neighbors and advertised prefixes manually.</p>
<table>
<thead>
<tr>
<th>Node</th>
<th>Neighbor</th>
<th style="text-align: right;">Neighbor AS</th>
<th style="text-align: right;">Neighbor IPv4</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>r1</strong></td>
<td>x1</td>
<td style="text-align: right;">65100</td>
<td style="text-align: right;">10.1.0.2</td>
</tr>
<tr>
<td><strong>r2</strong></td>
<td>x2</td>
<td style="text-align: right;">65101</td>
<td style="text-align: right;">10.1.0.10</td>
</tr>
<tr>
<td><strong>x1</strong></td>
<td>r1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;">10.1.0.1</td>
</tr>
<tr>
<td></td>
<td>x2</td>
<td style="text-align: right;">65101</td>
<td style="text-align: right;">10.1.0.6</td>
</tr>
<tr>
<td><strong>x2</strong></td>
<td>x1</td>
<td style="text-align: right;">65100</td>
<td style="text-align: right;">10.1.0.5</td>
</tr>
<tr>
<td></td>
<td>r2</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;">10.1.0.9</td>
</tr>
</tbody>
</table>
<h3 id="ospf-configuration">OSPF Configuration</h3>
<p>OSPF running in the backbone area is configured on the following routers:</p>
<table>
<thead>
<tr>
<th>Router</th>
<th>Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th>Neighbor(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>r1</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.1/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ethernet3</td>
<td style="text-align: right;">10.0.100.1/24</td>
<td>r2</td>
</tr>
<tr>
<td>r2</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.2/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ethernet3</td>
<td style="text-align: right;">10.0.100.2/24</td>
<td>r1</td>
</tr>
</tbody>
</table>
<h2 id="start-the-lab">Start the Lab</h2>
<p>Assuming you already <a href="../../1-setup/">set up your lab infrastructure</a>:</p>
<ul>
<li>Change directory to <code>ibgp/1-edge</code></li>
<li>Execute <strong>netlab up</strong> (<a href="#req">device requirements</a>, <a href="../../external/">other options</a>)</li>
<li>Log into your devices (R1, R2) with <strong>netlab connect</strong> and verify that <em>netlab</em> correctly configured their IP addresses, OSPF routing, and EBGP sessions.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you&rsquo;re not using <em>netlab</em>, you must configure R1 and R2 yourself.</p>
</div>
<h2 id="why-do-we-need-ibgp">Why Do We Need IBGP?</h2>
<p>Inspect the BGP tables on R1 and R2. They contain the routes received from upstream ISPs but not those received by the other WAN router &ndash; R1 cannot use the R2-X2 uplink to reach ISP-2 (and vice versa for R2). The following printouts contain BGP tables on R1 and R2 (Arista vEOS generated all printouts in this lab exercise):</p>
<p class="code-caption">BGP table on R1<br /></p>
<pre><code>r1&gt;show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.100.0/24          -                     -       -          -       0       i
 * &gt;      172.16.101.0/24        10.1.0.2              0       -          100     0       65100 65101 i
 * &gt;      192.168.100.0/24       10.1.0.2              0       -          100     0       65100 i
</code></pre>
<p class="code-caption">BGP table on R2<br /></p>
<pre><code>r2&gt;show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.100.0/24          -                     -       -          -       0       i
 * &gt;      172.16.101.0/24        10.1.0.10             0       -          100     0       65101 i
 * &gt;      192.168.100.0/24       10.1.0.10             0       -          100     0       65101 65100 i
</code></pre>
<p>The content of the BGP tables on R1 and R2 shouldn&rsquo;t surprise you; R1 and R2 are exchanging internal routes (using OSPF) but not external routes. We could &ldquo;solve&rdquo; the challenge by redistributing external routes into OSPF (hint: <a href="https://blog.ipspace.net/2020/10/redistributing-bgp-into-ospf.html">don&rsquo;t do that</a>), but then we&rsquo;d lose the BGP information like the AS path the routers need to compare the routes.</p>
<p>The only sensible way forward is establishing a BGP session between R1 and R2. Because that session is set up between two routers in the same autonomous system, we call it an <em>internal</em> BGP (IBGP) session.</p>
<h2 id="establish-ibgp-session">Establish IBGP Session</h2>
<p><strong>Configuration tasks:</strong></p>
<ul>
<li>Configure an IBGP session between the loopback interfaces of R1 and R2 (10.0.0.1 and 10.0.0.2) using a BGP configuration command similar to <strong>neighbor <em>address</em> remote-as 65000</strong>.</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You&rsquo;ll find more details in the <a href="../../basic/1-session/">Configure a Single EBGP Session</a> lab exercise.</p>
</div>
<ul>
<li>On some devices, you&rsquo;ll have to activate the IBGP session within the IPv4 <strong>address family</strong></li>
</ul>
<p><strong>Verification:</strong></p>
<p>Check the status of the IBGP session with a command similar to <strong>show ip bgp summary</strong> or <strong>show ip bgp neighbors</strong></p>
<p>The following printout contains the BGP summary information on R1 after configuring the IBGP session. As you can see, the router tries to establish the IBGP session but fails.</p>
<p class="code-caption">EBGP and IBGP neighbors on R1 (IBGP is not working)<br /></p>
<pre><code>r1#show ip bgp summary
BGP summary information for VRF default
Router identifier 10.0.0.1, local AS number 65000
Neighbor Status Codes: m - Under maintenance
  Description              Neighbor V AS           MsgRcvd   MsgSent  InQ OutQ  Up/Down State   PfxRcd PfxAcc
  r2                       10.0.0.2 4 65000              0         0    0    0 00:06:03 Active
  x1                       10.1.0.2 4 65100           2616      3068    0    0 02:10:34 Estab   2      2
</code></pre>
<h2 id="fix-the-source-ip-address-of-the-ibgp-session">Fix the Source IP Address of the IBGP Session</h2>
<p>BGP uses TCP as the transport protocol, and without further configuration, the TCP session&rsquo;s source IP address becomes the outgoing interface&rsquo;s IP address. Attempts to establish an IBGP session using the source IP address of the LAN interface are rejected by the IBGP neighbor as the source IP address in the TCP SYN packet does not match the neighbor IP address configured on the remote router.</p>
<p><strong>Configuration task:</strong></p>
<ul>
<li>Configure the source address of the IBGP TCP session with a BGP configuration command similar to <strong>neighbor update-source</strong>.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You could also configure the IBGP session between LAN IP addresses to make the lab work but never do that in a real-life network. You want the IBGP sessions to be stable, and the best way to achieve that goal is to use loopbacks as the endpoints of the TCP sessions (and rely on IGP to figure out how to reach remote loopbacks).</p>
</div>
<p><strong>Verification:</strong></p>
<p>After configuring the source IP address of the IBGP session on R1 and R2, the routers should be able to establish the IBGP session, as illustrated by the following printout:</p>
<p class="code-caption">EBGP and IBGP neighbors on R1 (after fixing the BGP source interface)<br /></p>
<pre><code>r1#show ip bgp summary
BGP summary information for VRF default
Router identifier 10.0.0.1, local AS number 65000
Neighbor Status Codes: m - Under maintenance
  Description              Neighbor V AS           MsgRcvd   MsgSent  InQ OutQ  Up/Down State   PfxRcd PfxAcc
  r2                       10.0.0.2 4 65000              8         8    0    0 00:00:07 Estab   2      2
  x1                       10.1.0.2 4 65100           2795      3276    0    0 02:19:28 Estab   2      2
</code></pre>
<p>After the IBGP session has been established, R1 and R2 exchange BGP prefixes received from X1 and X2, but the prefixes advertised by R2 are not selected as the best routes by R1 (and vice versa):</p>
<p class="code-caption">BGP table on R1 with a working IBGP session<br /></p>
<pre><code>r1#show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.100.0/24          -                     -       -          -       0       i
 *        10.0.100.0/24          10.0.0.2              0       -          100     0       i
 * &gt;      172.16.101.0/24        10.1.0.2              0       -          100     0       65100 65101 i
          172.16.101.0/24        10.1.0.10             0       -          100     0       65101 i
 * &gt;      192.168.100.0/24       10.1.0.2              0       -          100     0       65100 i
          192.168.100.0/24       10.1.0.10             0       -          100     0       65101 65100 i
</code></pre>
<p>Further investigation shows that the IBGP prefixes are not used because they are considered <em>invalid</em>.</p>
<p class="code-caption">A BGP prefix advertised by EBGP and IBGP neighbors<br /></p>
<pre><code>r1#show ip bgp 172.16.101.0
BGP routing table information for VRF default
Router identifier 10.0.0.1, local AS number 65000
BGP routing table entry for 172.16.101.0/24
 Paths: 2 available
  65100 65101
    10.1.0.2 from 10.1.0.2 (192.168.100.1)
      Origin IGP, metric 0, localpref 100, IGP metric 0, weight 0, tag 0
      Received 00:07:37 ago, valid, external, best
      Rx SAFI: Unicast
  65101
    10.1.0.10 from 10.0.0.2 (10.0.0.2)
      Origin IGP, metric 0, localpref 100, IGP metric -, weight 0, tag 0
      Received 00:05:29 ago, invalid, internal
      Rx SAFI: Unicast
</code></pre>
<p>Arista EOS is not helpful in this scenario; you have to guess that the underlying root cause is that the BGP next hop is unreachable <sup id="fnref:NHNR"><a class="footnote-ref" href="#fn:NHNR">1</a></sup>.</p>
<h2 id="fix-the-bgp-next-hop-of-ibgp-prefixes">Fix the BGP Next Hop of IBGP Prefixes</h2>
<p>BGP routers do not change the BGP next hop of EBGP routes when advertising them over IBGP &ndash; the BGP next hop of routes in AS 65101 as advertised by R2 to R1 is thus the IP address of X2 on the R2-X1 link (<a href="https://blog.ipspace.net/2011/08/bgp-next-hop-processing.html">more details</a>). R1 does not have a route to that IP subnet in its IP routing table, so it considers the IBGP prefix using that BGP next hop invalid.  </p>
<p>There are two approaches to make the BGP next hop of IBGP prefixes valid:</p>
<ul>
<li>You can include the external subnets in the IGP process (for example, making them part of the OSPF area).</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When using this approach, you must make the external subnets <em>passive</em> &ndash; you don&rsquo;t want to run IGP routing with another autonomous system.</p>
</div>
<ul>
<li>You can change the BGP next hop of the prefixes advertised over IBGP to the IP address of the advertising router. We&rsquo;ll use this approach.</li>
</ul>
<p><strong>Configuration task:</strong></p>
<ul>
<li>Change the BGP next hop of prefixes advertised over IBGP sessions with a BGP configuration command similar to <strong>neighbor next-hop-self</strong>.</li>
</ul>
<p><strong>Verification:</strong></p>
<p>Inspect the BGP tables and IP routing tables on R1 and R2 and verify that:</p>
<ul>
<li>R1 and R2 use BGP prefixes with the shortest AS path as the best BGP routes</li>
<li>BGP-derived IP prefixes in the IP routing tables point to the WAN uplinks or the LAN link between R1 and R2.</li>
</ul>
<p>You should get printouts similar to the ones generated by Arista EOS on R1:</p>
<p class="code-caption">BGP table on R1 with fixed BGP next hops<br /></p>
<pre><code>r1#show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.100.0/24          -                     -       -          -       0       i
 *        10.0.100.0/24          10.0.0.2              0       -          100     0       i
 * &gt;      172.16.101.0/24        10.0.0.2              0       -          100     0       65101 i
 *        172.16.101.0/24        10.1.0.2              0       -          100     0       65100 65101 i
 * &gt;      192.168.100.0/24       10.1.0.2              0       -          100     0       65100 i
</code></pre>
<p class="code-caption">A BGP prefix advertised over IBGP has the correct BGP next hop<br /></p>
<pre><code>r1#show ip bgp 172.16.101.0
BGP routing table information for VRF default
Router identifier 10.0.0.1, local AS number 65000
BGP routing table entry for 172.16.101.0/24
 Paths: 2 available
  65101
    10.0.0.2 from 10.0.0.2 (10.0.0.2)
      Origin IGP, metric 0, localpref 100, IGP metric 20, weight 0, tag 0
      Received 00:00:29 ago, valid, internal, best
      Rx SAFI: Unicast
  65100 65101
    10.1.0.2 from 10.1.0.2 (192.168.100.1)
      Origin IGP, metric 0, localpref 100, IGP metric 0, weight 0, tag 0
      Received 00:51:03 ago, valid, external
      Rx SAFI: Unicast
</code></pre>
<p class="code-caption">The final IP routing table on R1<br /></p>
<pre><code>r1#show ip route | begin Gateway
Gateway of last resort is not set

 C        10.0.0.1/32 is directly connected, Loopback0
 O        10.0.0.2/32 [110/20] via 10.0.100.2, Ethernet3
 C        10.0.100.0/24 is directly connected, Ethernet3
 C        10.1.0.0/30 is directly connected, Ethernet1
 B I      172.16.101.0/24 [200/0] via 10.0.100.2, Ethernet3
 B E      192.168.100.0/24 [200/0] via 10.1.0.2, Ethernet1
</code></pre>
<p><strong>Next:</strong></p>
<ul>
<li><a href="../2-transit/">Build a Transit Network with IBGP</a></li>
</ul>
<h2 id="automated-verification">Automated Verification</h2>
<p>You can use the <strong>netlab validate</strong> command if you&rsquo;ve installed <em>netlab</em> release 1.8.3 or later and use Cumulus Linux, FRR, or Arista EOS on R1 and R2. The validation tests check whether R1 and R2 propagate the X1/X2 prefixes over the IBGP session and whether they change the BGP next hop to their loopback IPv4 addresses.</p>
<p>This is the printout you should get after completing the lab exercise:</p>
<p><img alt="" src="../ibgp-edge-validate.png" /></p>
<h2 id="reference-information">Reference Information</h2>
<p>This lab uses the <a href="../../external/4-router/">4-router lab topology</a>. The following information might help you if you plan to build custom lab infrastructure:</p>
<h3 id="req">Device Requirements</h3>
<ul>
<li>Customer routers: use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP and OSPF configuration modules</a>.</li>
<li>Provider routers: use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP configuration module</a>.</li>
<li>You can do automated lab validation with Arista EOS, Cumulus Linux, or FRR running on R1 and R2. Automated lab validation requires <em>netlab</em> release 1.8.3 or higher.</li>
<li>Git repository contains provider routers&rsquo; initial device configurations for Cumulus Linux.</li>
</ul>
<h3 id="lab-wiring">Lab Wiring</h3>
<table>
<thead>
<tr>
<th>Link Name</th>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td>WAN uplink R1-to-X1</td>
<td>r1</td>
<td>Ethernet1</td>
<td>x1</td>
<td>swp1</td>
</tr>
<tr>
<td>WAN uplink R2-to-X2</td>
<td>r2</td>
<td>Ethernet2</td>
<td>x2</td>
<td>swp3</td>
</tr>
<tr>
<td>Inter-ISP link X1-to-X2</td>
<td>x1</td>
<td>swp2</td>
<td>x2</td>
<td>swp2</td>
</tr>
<tr>
<td>Intra-site LAN C1-C2</td>
<td>r1</td>
<td>Ethernet3</td>
<td>r2</td>
<td>Ethernet3</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: Some interfaces are not used to conform with the predefined 4-router lab topology.</p>
<h3 id="lab-addressing">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>r1</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;"></td>
<td>WAN uplink R1-to-X1</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>Ethernet3</td>
<td style="text-align: right;">10.0.100.1/24</td>
<td style="text-align: right;"></td>
<td>Intra-site LAN C1-C2</td>
</tr>
<tr>
<td><strong>r2</strong></td>
<td style="text-align: right;">10.0.0.2/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.9/30</td>
<td style="text-align: right;"></td>
<td>WAN uplink R2-to-X2</td>
</tr>
<tr>
<td>Ethernet3</td>
<td style="text-align: right;">10.0.100.2/24</td>
<td style="text-align: right;"></td>
<td>Intra-site LAN C1-C2</td>
</tr>
<tr>
<td><strong>x1</strong></td>
<td style="text-align: right;">192.168.100.1/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;"></td>
<td>WAN uplink R1-to-X1</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.5/30</td>
<td style="text-align: right;"></td>
<td>Inter-ISP link X1-to-X2</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td><strong>x2</strong></td>
<td style="text-align: right;">172.16.101.1/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.6/30</td>
<td style="text-align: right;"></td>
<td>Inter-ISP link X1-to-X2</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;">10.1.0.10/30</td>
<td style="text-align: right;"></td>
<td>WAN uplink R2-to-X2</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: Some interfaces are not configured with IP addresses to conform with the predefined 4-router lab topology.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:NHNR">
<p>Some network devices consider any BGP next hop reachable if they have a default route. That can happen in a virtual lab if the lab device does not use a management VRF &ndash; most lab environments use DHCP to add the default route pointing to the management interface. When that default route appears in the global IP routing table, the IBGP prefix could be considered valid, but the resulting route would point to the management interface.&#160;<a class="footnote-backref" href="#fnref:NHNR" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2023–2025 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
