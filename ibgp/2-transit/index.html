<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        <link rel="canonical" href="https://bgplabs.net/ibgp/2-transit/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Build a Transit Network with IBGP &#171; BGP Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BGP Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Home <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../2-labs-by-technology/" class="dropdown-item">Labs by BGP Attributes and Technologies</a>
</li>
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../99-about/" class="dropdown-item">About the Project</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Installation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
<li>
    <a href="../../4-codespaces/" class="dropdown-item">Use GitHub Codespaces</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Custom Lab Infrastructure</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../external/" class="dropdown-item">Manual Setup</a>
</li>
            
<li>
    <a href="../../external/4-router/" class="dropdown-item">Small (4-Router) Lab Topology</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Deploy BGP <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../basic/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Setting Up BGP</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/0-frrouting/" class="dropdown-item">Configuring Cumulus Linux and FRRouting</a>
</li>
            
<li>
    <a href="../../basic/1-session/" class="dropdown-item">Configure a Single EBGP Session</a>
</li>
            
<li>
    <a href="../../basic/2-multihomed/" class="dropdown-item">Configure Multiple EBGP Sessions</a>
</li>
            
<li>
    <a href="../../basic/3-originate/" class="dropdown-item">Advertise IPv4 Prefixes to BGP Neighbors</a>
</li>
            
<li>
    <a href="../../basic/4-ipv6/" class="dropdown-item">Configure BGP for IPv6</a>
</li>
            
<li>
    <a href="../../basic/5-redistribute/" class="dropdown-item">Redistribute IGP Information Into BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Protecting BGP Sessions</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/6-protect/" class="dropdown-item">MD5 Passwords and GTSM</a>
</li>
            
<li>
    <a href="../../basic/9-ao/" class="dropdown-item">TCP Autentication Option (TCP-AO)</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">BGP in Larger Networks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../1-edge/" class="dropdown-item">Establish an IBGP Session</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Build a Transit Network with IBGP</a>
</li>
            
<li>
    <a href="../3-rr/" class="dropdown-item">Use BGP Route Reflectors</a>
</li>
            
<li>
    <a href="../../session/6-templates/" class="dropdown-item">BGP Session Templates</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
            
<li>
    <a href="../../session/9-dynamic/" class="dropdown-item">Dynamic BGP Peers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Manipulate AS Path</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../session/1-allowas_in/" class="dropdown-item">Reuse a BGP AS Number Across Multiple Sites</a>
</li>
            
<li>
    <a href="../../session/2-asoverride/" class="dropdown-item">Fix AS-Path in Environments Reusing BGP AS Numbers</a>
</li>
            
<li>
    <a href="../../session/3-localas/" class="dropdown-item">Use Multiple AS Numbers on the Same Router</a>
</li>
            
<li>
    <a href="../../session/4-removeprivate/" class="dropdown-item">Remove Private BGP AS Numbers from the AS Path</a>
</li>
            
<li>
    <a href="../../session/5-routeserver/" class="dropdown-item">BGP Route Server in an Internet Exchange Point</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Load Balancing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lb/1-ebgp/" class="dropdown-item">Load Balancing across External BGP Paths</a>
</li>
            
<li>
    <a href="../../lb/2-dmz-bw/" class="dropdown-item">EBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/3-ibgp/" class="dropdown-item">IBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/4-ibgp-add-path/" class="dropdown-item">IBGP Load Balancing with BGP Additional Paths</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Other Useful Topics</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/7-bfd/" class="dropdown-item">Use BGP Timers and BFD to Speed Up BGP Convergence</a>
</li>
            
<li>
    <a href="../../basic/8-aggregate/" class="dropdown-item">BGP Route Aggregation</a>
</li>
            
<li>
    <a href="../../basic/c-default-route/" class="dropdown-item">Advertise Default Route in BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
            
<li>
    <a href="../../basic/e-ebgp-multihop/" class="dropdown-item">Running EBGP Across a Firewall</a>
</li>
            
<li>
    <a href="../../session/8-passive/" class="dropdown-item">Passive BGP Sessions</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Routing Policies <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../policy/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Route Filters</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/2-stop-transit/" class="dropdown-item">Filter Transit Routes</a>
</li>
            
<li>
    <a href="../../policy/3-prefix/" class="dropdown-item">Filter Advertised Prefixes</a>
</li>
            
<li>
    <a href="../../policy/4-reduce/" class="dropdown-item">Minimize the Size of Your BGP Table</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
            
<li>
    <a href="../../policy/d-no-export/" class="dropdown-item">Using No-Export Community to Filter Transit Routes</a>
</li>
            
<li>
    <a href="../../policy/f-orf/" class="dropdown-item">Use Outbound Route Filters (ORF) for IP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Outgoing (Egress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/1-weights/" class="dropdown-item">Select Preferred EBGP Peer with Weights</a>
</li>
            
<li>
    <a href="../../policy/5-local-preference/" class="dropdown-item">Select Preferred Uplink with BGP Local Preference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Incoming (Ingress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/6-med/" class="dropdown-item">Use MED to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../../policy/7-prepend/" class="dropdown-item">Use AS-Path Prepending to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../../policy/8-community-attach/" class="dropdown-item">Attach BGP Communities to Outgoing BGP Updates</a>
</li>
            
<li>
    <a href="../../policy/e-wedgies/" class="dropdown-item">Resolve BGP Wedgies</a>
</li>
            
<li>
    <a href="../../policy/b-disaggregate/" class="dropdown-item">Use Disaggregated Prefixes to Select the Primary Link</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">More Complex Routing Policies</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/9-community-use/" class="dropdown-item">Use BGP Communities in Routing Policies</a>
</li>
            
<li>
    <a href="../../policy/a-locpref-route-map/" class="dropdown-item">BGP Local Preference in a Complex Routing Policy</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Challenges <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../challenge/03-graceful-shutdown/" class="dropdown-item">BGP Graceful Shutdown</a>
</li>
                                    
<li>
    <a href="../../challenge/04-block-fat-fingers/" class="dropdown-item">Stop the Propagation of Configuration Errors</a>
</li>
                                    
<li>
    <a href="../../challenge/20-merge-as/" class="dropdown-item">Merge Networks Using Different BGP AS Numbers</a>
</li>
                                    
<li>
    <a href="../../challenge/30-reduce-fib/" class="dropdown-item">Minimize the Forwarding Table on BGP Routers</a>
</li>
                                    
<li>
    <a href="../../challenge/40-mpls-core/" class="dropdown-item">BGP-Free Core in a Transit Network</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Upcoming <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../challenge/01-bird-rr/" class="dropdown-item">Using Bird BGP Daemon as a BGP Route Reflector</a>
</li>
                                    
<li>
    <a href="../../challenge/02-anycast/" class="dropdown-item">Implement Anycast Services with BGP</a>
</li>
                                    
<li>
    <a href="../../challenge/05-ebgp-dc/" class="dropdown-item">EBGP-Only Data Center Design</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../1-edge/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../3-rr/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>

                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
  <div class="navbar-header">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
          <span class="fa fa-angle-down"></span>
      </button>
  </div>

  
  
  
  
  
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary"  style="margin-bottom: 1em;">
      <ul class="nav flex-column">
          
      <li class="nav-item" data-level="1"><a href="#build-a-transit-network-with-ibgp" class="nav-link">Build a Transit Network with IBGP</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="2"><a href="#existing-lab-configuration" class="nav-link">Existing Lab Configuration</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#bgp-configuration" class="nav-link">BGP Configuration</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#ospf-configuration" class="nav-link">OSPF Configuration</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#start-the-lab" class="nav-link">Start the Lab</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#propagate-external-bgp-routes-to-pe2" class="nav-link">Propagate External BGP Routes to PE2</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#fixing-the-core-routing" class="nav-link">Fixing the Core Routing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#req" class="nav-link">Device Requirements</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-wiring" class="nav-link">Lab Wiring</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-addressing" class="nav-link">Lab Addressing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
        </ul>
      </li>
      </ul>
    </div>
  
  
  
  
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="build-a-transit-network-with-ibgp">Build a Transit Network with IBGP</h1>
<p>In the <em><a href="../1-edge/">Establish an IBGP Session Between WAN Edge Routers</a></em> lab exercise, you built a simple network with two adjacent BGP routers. In this exercise, you&rsquo;ll explore the impact of adding a core router between edge routers running BGP.</p>
<p><img alt="Lab topology" src="../topology-ibgp-transit.png" /></p>
<p>After starting the lab, you&rsquo;ll have to configure all the IBGP sessions needed to establish connectivity between the loopback interfaces of PE2 and EXT routers. You MUST NOT use route redistribution between OSPF and BGP to solve the connectivity issues (there&rsquo;s an <a href="https://blog.ipspace.net/2020/10/redistributing-bgp-into-ospf.html">excellent reason</a> for that restriction).</p>
<h2 id="existing-lab-configuration">Existing Lab Configuration</h2>
<p>When starting the lab with <em>netlab</em>, you&rsquo;ll get a preconfigured lab:</p>
<ul>
<li>All routers will have their interfaces and IP addresses configured</li>
<li>OSPF will be running between PE1, PE2, and CORE routers.</li>
<li>BGP will be configured on PE1, PE2 and EXT routers. All three routers will advertise their loopback interfaces in BGP.</li>
<li>There will be an EBGP session between PE1 and EXT routers.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>To simplify the verification process, the lab topology uses an unnumbered IPv4 link between PE2 and CORE routers. That link will be changed to a regular IPv4 subnet if your devices don&rsquo;t <a href="https://netlab.tools/platforms/#platform-initial-addresses">support unnumbered IPv4 links</a> or cannot <a href="https://netlab.tools/module/ospf/#ospf-interfaces">run OSPF over unnumbered IPv4 links</a>, resulting in a slight change in IP routing tables and printouts.</p>
</div>
<p>The following tables summarize the existing lab configuration.</p>
<h3 id="bgp-configuration">BGP Configuration</h3>
<p>The routers in your lab use the following BGP AS numbers. The external router advertises an IPv4 prefix; your PE routers advertise their loopback IPv4 addresses.</p>
<table>
<thead>
<tr>
<th>Node/ASN</th>
<th style="text-align: right;">Router ID</th>
<th style="text-align: right;">Advertised prefixes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AS65000</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>pe1</td>
<td style="text-align: right;">10.0.0.2</td>
<td style="text-align: right;">10.0.0.2/32</td>
</tr>
<tr>
<td>pe2</td>
<td style="text-align: right;">10.0.0.3</td>
<td style="text-align: right;">10.0.0.3/32</td>
</tr>
<tr>
<td><strong>AS65100</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>ext</td>
<td style="text-align: right;">10.0.0.10</td>
<td style="text-align: right;">172.16.42.0/24</td>
</tr>
</tbody>
</table>
<p><em>netlab</em> also configures the EBGP session between PE1 and EXT routers.</p>
<table>
<thead>
<tr>
<th>Node</th>
<th>Neighbor</th>
<th style="text-align: right;">Neighbor AS</th>
<th style="text-align: right;">Neighbor IPv4</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ext</strong></td>
<td>pe1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;">10.1.0.6</td>
</tr>
<tr>
<td><strong>pe1</strong></td>
<td>ext</td>
<td style="text-align: right;">65100</td>
<td style="text-align: right;">10.1.0.5</td>
</tr>
</tbody>
</table>
<h3 id="ospf-configuration">OSPF Configuration</h3>
<p>OSPF backbone area is configured on the following routers in AS 65000:</p>
<table>
<thead>
<tr>
<th>Router</th>
<th>Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th>Neighbor(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>core</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.1/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td>pe1</td>
</tr>
<tr>
<td></td>
<td>Ethernet3</td>
<td style="text-align: right;">True</td>
<td>pe2</td>
</tr>
<tr>
<td>pe1</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.2/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>swp1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td>core</td>
</tr>
<tr>
<td>pe2</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.3/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ethernet3</td>
<td style="text-align: right;">True</td>
<td>core</td>
</tr>
</tbody>
</table>
<h2 id="start-the-lab">Start the Lab</h2>
<p>Assuming you already <a href="../../1-setup/">set up your lab infrastructure</a>:</p>
<ul>
<li>Change directory to <code>ibgp/2-transit</code></li>
<li>Execute <strong>netlab up</strong> (<a href="#req">device requirements</a>, <a href="../../external/">other options</a>)</li>
<li>Log into your devices (R1, R2) with <strong>netlab connect</strong> and verify that <em>netlab</em> correctly configured their IP addresses, OSPF routing, and EBGP sessions.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul>
<li>This lab requires <em>netlab</em> release 1.7.0 or higher.</li>
<li>If you&rsquo;re not using <em>netlab</em>, you must configure CORE and PE2 routers yourself. Configurations for PE1 and EXT routers are in the <code>config</code> subdirectory.</li>
</ul>
</div>
<h2 id="propagate-external-bgp-routes-to-pe2">Propagate External BGP Routes to PE2</h2>
<p>Try to ping the external router (<code>172.16.42.42</code>) from PE2. You have to check the connectivity between the loopback addresses, so you should use a version of the <strong>ping</strong> command that specifies the source interface or the source IP address. For example, you must use <code>ping 172.16.42.42 source loop 0</code> on Arista EOS.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ul>
<li>You don&rsquo;t have to worry about the source IP address of the ICMP Echo packets on devices that support unnumbered IPv4 interfaces. These devices will automatically set the packet&rsquo;s source IP address to the device&rsquo;s loopback IP address.</li>
<li>The extended <strong>ping</strong> command is often available only in privileged (<strong>enable</strong>) CLI mode.</li>
</ul>
</div>
<p>The <strong>ping</strong> command will most likely fail<sup id="fnref:DP"><a class="footnote-ref" href="#fn:DP">1</a></sup>. Arista EOS displays the root cause of the failure: the destination network is not in the IP routing table:</p>
<pre><code>pe2#ping 172.16.42.42 source loop 0
PING 172.16.42.42 (172.16.42.42) from 10.0.0.3 : 72(100) bytes of data.
ping: sendmsg: Network is unreachable
ping: sendmsg: Network is unreachable
ping: sendmsg: Network is unreachable
ping: sendmsg: Network is unreachable
ping: sendmsg: Network is unreachable

--- 172.16.42.42 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 40ms
</code></pre>
<p>A quick look into the routing- and BGP table on PE2<sup id="fnref:UBP"><a class="footnote-ref" href="#fn:UBP">2</a></sup> confirms that PE2 knows nothing about the IPv4 prefix <code>172.16.42.0/24</code>.</p>
<pre><code>pe2#show ip route | begin Gateway
Gateway of last resort is not set

 O        10.0.0.1/32 is directly connected, Ethernet3
 O        10.0.0.2/32 [110/20] via 10.0.0.1, Ethernet3
 C        10.0.0.3/32 is directly connected, Loopback0
 O        10.1.0.0/30 [110/20] via 10.0.0.1, Ethernet3

pe2#show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.0.3/32            -                     -       -          -       0       i
</code></pre>
<p>The lack of BGP routes on PE2 shouldn&rsquo;t surprise you if you completed the <em><a href="../1-edge/">Establish an IBGP Session Between WAN Edge Routers</a></em> lab exercise &ndash; you already know you need an IBGP session between PE1 and PE2.</p>
<p><strong>Configuration task:</strong></p>
<ul>
<li>Configure an IBGP session between the loopback interfaces of PE1 and PE2<sup id="fnref:DFA"><a class="footnote-ref" href="#fn:DFA">3</a></sup>.</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The IBGP session is preconfigured on PE1 and should be established as soon as you configure it on PE2.</p>
</div>
<p><strong>Verification:</strong></p>
<p>Check the BGP neighbors and the BGP table on PE2. You should see an established IBGP session between PE1 and PE2 in the BGP summary printout and the BGP route for <code>172.16.42.0/24</code> in the BGP table.</p>
<p>This is the printout you should get on Arista EOS:</p>
<pre><code>pe2#show ip bgp sum
BGP summary information for VRF default
Router identifier 10.0.0.3, local AS number 65000
Neighbor Status Codes: m - Under maintenance
  Neighbor V AS           MsgRcvd   MsgSent  InQ OutQ  Up/Down State   PfxRcd PfxAcc
  10.0.0.2 4 65000             20        20    0    0 00:00:08 Estab   2      2
pe2#show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.0.2/32            10.0.0.2              0       -          100     0       i
 * &gt;      10.0.0.3/32            -                     -       -          -       0       i
 * &gt;      172.16.42.0/24         10.0.0.2              0       -          100     0       65100 i
</code></pre>
<p>Retry the <strong>ping</strong> command. It should no longer complain that the network is unreachable but could generate another bit of information on devices that parse and display ICMP error reports. For example, Arista EOS reports that the CORE router (10.0.0.1) claims it cannot reach the destination:</p>
<pre><code>pe2#ping 172.16.42.42 source loop 0
PING 172.16.42.42 (172.16.42.42) from 10.0.0.3 : 72(100) bytes of data.
From 10.0.0.1 icmp_seq=1 Destination Net Unreachable

--- 172.16.42.42 ping statistics ---
5 packets transmitted, 0 received, +1 errors, 100% packet loss, time 30ms
</code></pre>
<h2 id="fixing-the-core-routing">Fixing the Core Routing</h2>
<p>Log into the router complaining it cannot reach the destination (the CORE router) and check its IP routing table. The route for <code>172.16.42.0/24</code> is missing.</p>
<pre><code>core#show ip route | begin Gateway
Gateway of last resort is not set

 C        10.0.0.1/32 is directly connected, Loopback0
 O        10.0.0.2/32 [110/10] via 10.1.0.2, Ethernet1
 O        10.0.0.3/32 is directly connected, Ethernet3
 C        10.1.0.0/30 is directly connected, Ethernet1
</code></pre>
<p>That shouldn&rsquo;t be a big surprise; after all, the external prefix is advertised only in BGP, and the CORE router runs only OSPF.</p>
<p>There are at least four ways to fix the routing in the core of your autonomous system:</p>
<ul>
<li>Redistribute EBGP information into OSPF. That&rsquo;s <a href="https://blog.ipspace.net/2020/10/redistributing-bgp-into-ospf.html">dangerous in real-life networks with large BGP tables</a>, and thus, you are not allowed to do it in this lab exercise.</li>
<li>Advertise an OSPF default route from PE1. That would solve your immediate problem but wouldn&rsquo;t result in an actual transit network &ndash; you would run into &ldquo;exciting&rdquo; challenges when trying to connect external networks to PE2. This option is thus also off the table.</li>
<li>Hide the transit packets from the CORE router using MPLS or IP-over-something tunnels. While the MPLS approach is commonly used to <a href="https://blog.ipspace.net/2012/01/bgp-free-service-provider-core-in.html">build BGP-free core networks</a>, it&rsquo;s too complex for this lab exercise<sup id="fnref:FFDI"><a class="footnote-ref" href="#fn:FFDI">4</a></sup>.</li>
<li>Make the CORE router part of the BGP routing. This is the approach we&rsquo;ll use.</li>
</ul>
<p><strong>Configuration tasks:</strong></p>
<ul>
<li>Configure BGP with AS number 65000 on the CORE router</li>
<li>Configure IBGP sessions between all BGP routers in AS 65000.</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ul>
<li>Due to the IBGP loop avoidance mechanism (never advertise IBGP routes to other IBGP neighbors), you must configure a full mesh of IBGP sessions, adding PE1-CORE and PE2-CORE IBGP sessions. Your lab might work without the PE2-CORE IBGP session but would probably stop working when you connect an EBGP neighbor to PE2<sup id="fnref:DLER"><a class="footnote-ref" href="#fn:DLER">5</a></sup>.</li>
<li>The IBGP session between PE1 and CORE routers is preconfigured on PE1 and should be established as soon as you configure it on the CORE router. You&rsquo;ll have to configure the PE2-CORE IBGP session on both ends.</li>
<li>If you&rsquo;re working with FRR or Cumulus Linux, save the CORE router&rsquo;s current configuration before enabling the BGP daemon and restarting FRR.</li>
</ul>
</div>
<p><strong>Verification:</strong></p>
<p>Check the BGP neighbors and the BGP table on the CORE router. The router should have two established IBGP sessions and three prefixes in its BGP table:</p>
<pre><code>core#show ip bgp sum
BGP summary information for VRF default
Router identifier 10.0.0.1, local AS number 65000
Neighbor Status Codes: m - Under maintenance
  Neighbor V AS           MsgRcvd   MsgSent  InQ OutQ  Up/Down State   PfxRcd PfxAcc
  10.0.0.2 4 65000             14        14    0    0 00:00:10 Estab   2      2
  10.0.0.3 4 65000             10         9    0    0 00:00:08 Estab   1      1
core#show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.0.2/32            10.0.0.2              0       -          100     0       i
 * &gt;      10.0.0.3/32            10.0.0.3              0       -          100     0       i
 * &gt;      172.16.42.0/24         10.0.0.2              0       -          100     0       65100 i
</code></pre>
<p>Retry the <strong>ping</strong> command on PE2. PE2 should be able to reach the EXT router:</p>
<pre><code>pe2#ping 172.16.42.42 source loop 0
PING 172.16.42.42 (172.16.42.42) from 10.0.0.3 : 72(100) bytes of data.
80 bytes from 172.16.42.42: icmp_seq=1 ttl=62 time=0.086 ms
80 bytes from 172.16.42.42: icmp_seq=2 ttl=62 time=0.007 ms
80 bytes from 172.16.42.42: icmp_seq=3 ttl=62 time=0.008 ms
80 bytes from 172.16.42.42: icmp_seq=4 ttl=62 time=0.006 ms
80 bytes from 172.16.42.42: icmp_seq=5 ttl=62 time=0.007 ms

--- 172.16.42.42 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.006/0.022/0.086/0.032 ms, ipg/ewma 0.032/0.053 ms
</code></pre>
<p><strong>Next:</strong> <a href="../3-rr/">Use BGP Route Reflectors</a></p>
<h2 id="reference-information">Reference Information</h2>
<p>This lab uses the <a href="../../external/4-router/">4-router lab topology</a>. The following information might help you if you plan to build custom lab infrastructure:</p>
<h3 id="req">Device Requirements</h3>
<ul>
<li>Use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP and OSPF configuration modules</a>.</li>
<li>Git repository contains initial device configurations for Cumulus Linux.</li>
</ul>
<h3 id="lab-wiring">Lab Wiring</h3>
<p>This lab uses the <a href="../../external/4-router/">4-router lab topology</a> with the following mapping between the routers in the 4-router lab topology and this lab:</p>
<table>
<thead>
<tr>
<th>4-router-topology device</th>
<th>Lab device</th>
</tr>
</thead>
<tbody>
<tr>
<td>C1</td>
<td>Core</td>
</tr>
<tr>
<td>C2</td>
<td>PE2</td>
</tr>
<tr>
<td>X1</td>
<td>PE1</td>
</tr>
<tr>
<td>X2</td>
<td>EXT</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Link Name</th>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>core</td>
<td>Ethernet1</td>
<td>pe1</td>
<td>swp1</td>
</tr>
<tr>
<td>Unused link</td>
<td>core</td>
<td>Ethernet2</td>
<td>ext</td>
<td>swp1</td>
</tr>
<tr>
<td>Inter-AS link</td>
<td>pe1</td>
<td>swp2</td>
<td>ext</td>
<td>swp2</td>
</tr>
<tr>
<td>Unused link</td>
<td>pe2</td>
<td>Ethernet1</td>
<td>pe1</td>
<td>swp3</td>
</tr>
<tr>
<td>Unused link</td>
<td>pe2</td>
<td>Ethernet2</td>
<td>ext</td>
<td>swp3</td>
</tr>
<tr>
<td></td>
<td>core</td>
<td>Ethernet3</td>
<td>pe2</td>
<td>Ethernet3</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: Some interfaces are not used to conform with the predefined 4-router lab topology.</p>
<h3 id="lab-addressing">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>core</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;"></td>
<td>core -&gt; pe1</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>Ethernet3</td>
<td style="text-align: right;">True</td>
<td style="text-align: right;"></td>
<td>core -&gt; pe2</td>
</tr>
<tr>
<td><strong>ext</strong></td>
<td style="text-align: right;">172.16.42.42/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.5/30</td>
<td style="text-align: right;"></td>
<td>Inter-AS link</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td><strong>pe1</strong></td>
<td style="text-align: right;">10.0.0.2/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;"></td>
<td>pe1 -&gt; core</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.6/30</td>
<td style="text-align: right;"></td>
<td>Inter-AS link</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td><strong>pe2</strong></td>
<td style="text-align: right;">10.0.0.3/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>Ethernet3</td>
<td style="text-align: right;">True</td>
<td style="text-align: right;"></td>
<td>pe2 -&gt; core</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: Some interfaces are not configured with IP addresses to conform with the predefined 4-router lab topology.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:DP">
<p>If it doesn&rsquo;t, you have a more interesting problem to troubleshoot &ndash; why does it work?&#160;<a class="footnote-backref" href="#fnref:DP" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:UBP">
<p>Most <strong>show</strong> printouts in this lab exercise use the <code>| begin Something</code> pipe to skip the (mostly irrelevant) header information.&#160;<a class="footnote-backref" href="#fnref:UBP" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:DFA">
<p>Remember to activate the IBGP session within the IPv4 address family (AF) if your device requires per-AF neighbor activation.&#160;<a class="footnote-backref" href="#fnref:DFA" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:FFDI">
<p>&hellip; but as you have a running lab that&rsquo;s easy to restart, please feel free to try to get it to work. You get bonus points if you <a href="https://blog.ipspace.net/2021/05/segment-routing-mpls-bgp-free-core.html">decide to use Segment Routing</a> and a virtual 6-pack of Kool-Aid if you use SRv6 ;)&#160;<a class="footnote-backref" href="#fnref:FFDI" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:DLER">
<p>Proving that is left as an exercise for the reader&#160;<a class="footnote-backref" href="#fnref:DLER" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2023–2024 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
