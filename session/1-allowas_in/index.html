<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        <link rel="canonical" href="https://bgplabs.net/session/1-allowas_in/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Reuse a BGP AS Number Across Multiple Sites &#171; BGP Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BGP Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Home <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../2-labs-by-technology/" class="dropdown-item">Labs by BGP Attributes and Technologies</a>
</li>
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../99-about/" class="dropdown-item">About the Project</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Installation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
<li>
    <a href="../../4-codespaces/" class="dropdown-item">Use GitHub Codespaces</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Custom Lab Infrastructure</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../external/" class="dropdown-item">Manual Setup</a>
</li>
            
<li>
    <a href="../../external/4-router/" class="dropdown-item">Small (4-Router) Lab Topology</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Deploy BGP <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../basic/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Setting Up BGP</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/0-frrouting/" class="dropdown-item">Configuring Cumulus Linux and FRRouting</a>
</li>
            
<li>
    <a href="../../basic/1-session/" class="dropdown-item">Configure a Single EBGP Session</a>
</li>
            
<li>
    <a href="../../basic/2-multihomed/" class="dropdown-item">Configure Multiple EBGP Sessions</a>
</li>
            
<li>
    <a href="../../basic/3-originate/" class="dropdown-item">Advertise IPv4 Prefixes to BGP Neighbors</a>
</li>
            
<li>
    <a href="../../basic/4-ipv6/" class="dropdown-item">Configure BGP for IPv6</a>
</li>
            
<li>
    <a href="../../basic/5-redistribute/" class="dropdown-item">Redistribute IGP Information Into BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Protecting BGP Sessions</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/6-protect/" class="dropdown-item">MD5 Passwords and GTSM</a>
</li>
            
<li>
    <a href="../../basic/9-ao/" class="dropdown-item">TCP Autentication Option (TCP-AO)</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">BGP in Larger Networks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../ibgp/1-edge/" class="dropdown-item">Establish an IBGP Session</a>
</li>
            
<li>
    <a href="../../ibgp/2-transit/" class="dropdown-item">Build a Transit Network with IBGP</a>
</li>
            
<li>
    <a href="../../ibgp/3-rr/" class="dropdown-item">Use BGP Route Reflectors</a>
</li>
            
<li>
    <a href="../6-templates/" class="dropdown-item">BGP Session Templates</a>
</li>
            
<li>
    <a href="../7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
            
<li>
    <a href="../9-dynamic/" class="dropdown-item">Dynamic BGP Peers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Manipulate AS Path</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="./" class="dropdown-item active">Reuse a BGP AS Number Across Multiple Sites</a>
</li>
            
<li>
    <a href="../2-asoverride/" class="dropdown-item">Fix AS-Path in Environments Reusing BGP AS Numbers</a>
</li>
            
<li>
    <a href="../3-localas/" class="dropdown-item">Use Multiple AS Numbers on the Same Router</a>
</li>
            
<li>
    <a href="../4-removeprivate/" class="dropdown-item">Remove Private BGP AS Numbers from the AS Path</a>
</li>
            
<li>
    <a href="../5-routeserver/" class="dropdown-item">BGP Route Server in an Internet Exchange Point</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Load Balancing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lb/1-ebgp/" class="dropdown-item">Load Balancing across External BGP Paths</a>
</li>
            
<li>
    <a href="../../lb/2-dmz-bw/" class="dropdown-item">EBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/3-ibgp/" class="dropdown-item">IBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/4-ibgp-add-path/" class="dropdown-item">IBGP Load Balancing with BGP Additional Paths</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Other Useful Topics</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/7-bfd/" class="dropdown-item">Use BGP Timers and BFD to Speed Up BGP Convergence</a>
</li>
            
<li>
    <a href="../../basic/8-aggregate/" class="dropdown-item">BGP Route Aggregation</a>
</li>
            
<li>
    <a href="../../basic/c-default-route/" class="dropdown-item">Advertise Default Route in BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
            
<li>
    <a href="../../basic/e-ebgp-multihop/" class="dropdown-item">Running EBGP Across a Firewall</a>
</li>
            
<li>
    <a href="../8-passive/" class="dropdown-item">Passive BGP Sessions</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Routing Policies <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../policy/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Route Filters</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/2-stop-transit/" class="dropdown-item">Filter Transit Routes</a>
</li>
            
<li>
    <a href="../../policy/3-prefix/" class="dropdown-item">Filter Advertised Prefixes</a>
</li>
            
<li>
    <a href="../../policy/4-reduce/" class="dropdown-item">Minimize the Size of Your BGP Table</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
            
<li>
    <a href="../../policy/d-no-export/" class="dropdown-item">Using No-Export Community to Filter Transit Routes</a>
</li>
            
<li>
    <a href="../../policy/f-orf/" class="dropdown-item">Use Outbound Route Filters (ORF) for IP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Outgoing (Egress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/1-weights/" class="dropdown-item">Select Preferred EBGP Peer with Weights</a>
</li>
            
<li>
    <a href="../../policy/5-local-preference/" class="dropdown-item">Select Preferred Uplink with BGP Local Preference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Incoming (Ingress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/6-med/" class="dropdown-item">Use MED to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../../policy/7-prepend/" class="dropdown-item">Use AS-Path Prepending to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../../policy/8-community-attach/" class="dropdown-item">Attach BGP Communities to Outgoing BGP Updates</a>
</li>
            
<li>
    <a href="../../policy/e-wedgies/" class="dropdown-item">Resolve BGP Wedgies</a>
</li>
            
<li>
    <a href="../../policy/b-disaggregate/" class="dropdown-item">Use Disaggregated Prefixes to Select the Primary Link</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">More Complex Routing Policies</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../policy/9-community-use/" class="dropdown-item">Use BGP Communities in Routing Policies</a>
</li>
            
<li>
    <a href="../../policy/a-locpref-route-map/" class="dropdown-item">BGP Local Preference in a Complex Routing Policy</a>
</li>
            
<li>
    <a href="../7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Challenges <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../challenge/03-graceful-shutdown/" class="dropdown-item">BGP Graceful Shutdown</a>
</li>
                                    
<li>
    <a href="../../challenge/04-block-fat-fingers/" class="dropdown-item">Stop the Propagation of Configuration Errors</a>
</li>
                                    
<li>
    <a href="../../challenge/20-merge-as/" class="dropdown-item">Merge Networks Using Different BGP AS Numbers</a>
</li>
                                    
<li>
    <a href="../../challenge/30-reduce-fib/" class="dropdown-item">Minimize the Forwarding Table on BGP Routers</a>
</li>
                                    
<li>
    <a href="../../challenge/40-mpls-core/" class="dropdown-item">BGP-Free Core in a Transit Network</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Upcoming <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../challenge/01-bird-rr/" class="dropdown-item">Using Bird BGP Daemon as a BGP Route Reflector</a>
</li>
                                    
<li>
    <a href="../../challenge/02-anycast/" class="dropdown-item">Implement Anycast Services with BGP</a>
</li>
                                    
<li>
    <a href="../../challenge/05-ebgp-dc/" class="dropdown-item">EBGP-Only Data Center Design</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../9-dynamic/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../2-asoverride/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>

                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
  <div class="navbar-header">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
          <span class="fa fa-angle-down"></span>
      </button>
  </div>

  
  
  
  
  
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary"  style="margin-bottom: 1em;">
      <ul class="nav flex-column">
          
      <li class="nav-item" data-level="1"><a href="#reuse-a-bgp-as-number-across-multiple-sites" class="nav-link">Reuse a BGP AS Number Across Multiple Sites</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="2"><a href="#existing-bgp-configuration" class="nav-link">Existing BGP Configuration</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#start-the-lab" class="nav-link">Start the Lab</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#the-problem" class="nav-link">The Problem</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#why-are-the-loopback-prefixes-not-propagated" class="nav-link">Why Are the Loopback Prefixes Not Propagated?</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#configuration-task" class="nav-link">Configuration Task</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#ver" class="nav-link">Verification</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#req" class="nav-link">Device Requirements</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-wiring" class="nav-link">Lab Wiring</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-addressing" class="nav-link">Lab Addressing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
        </ul>
      </li>
      </ul>
    </div>
  
  
  
  
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="reuse-a-bgp-as-number-across-multiple-sites">Reuse a BGP AS Number Across Multiple Sites</h1>
<p>In the <a href="https://bgplabs.net/basic/5-redistribute/">Redistribute IGP Information Into BGP</a> exercise, you practiced using BGP with a service provider offering MPLS/VPN services. At that time, the service provider gave you two autonomous systems (one per site), which might not be feasible for large service providers<sup id="fnref:4B"><a class="footnote-ref" href="#fn:4B">1</a></sup>. In this lab, you&rsquo;ll practice a more realistic scenario in which you get the same BGP AS number for all sites.</p>
<p><img alt="Lab topology" src="../topology-allowas.png" /></p>
<h2 id="existing-bgp-configuration">Existing BGP Configuration</h2>
<p>The routers in your lab use the following BGP AS numbers. The ISP routers do not advertise local prefixes; your routers advertise their loopbacks.</p>
<table>
<thead>
<tr>
<th>Node/ASN</th>
<th style="text-align: right;">Router ID</th>
<th style="text-align: right;">Advertised prefixes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AS65000</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>ce1</td>
<td style="text-align: right;">10.0.0.1</td>
<td style="text-align: right;">10.0.0.1/32</td>
</tr>
<tr>
<td>ce2</td>
<td style="text-align: right;">10.0.0.2</td>
<td style="text-align: right;">10.0.0.2/32</td>
</tr>
<tr>
<td><strong>AS65100</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>pe1</td>
<td style="text-align: right;">10.0.0.10</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>pe2</td>
<td style="text-align: right;">10.0.0.11</td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
<p>Your routers have these EBGP neighbors. <em>netlab</em> configures them automatically; if you&rsquo;re using some other lab infrastructure, you&rsquo;ll have to configure EBGP neighbors and advertised prefixes manually.</p>
<table>
<thead>
<tr>
<th>Node</th>
<th>Router ID /<br />Neighbor</th>
<th style="text-align: right;">Router AS/<br />Neighbor AS</th>
<th style="text-align: right;">Neighbor IPv4</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ce1</strong></td>
<td>10.0.0.1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>pe1</td>
<td style="text-align: right;">65100</td>
<td style="text-align: right;">10.1.0.2</td>
</tr>
<tr>
<td><strong>ce2</strong></td>
<td>10.0.0.2</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>pe2</td>
<td style="text-align: right;">65100</td>
<td style="text-align: right;">10.1.0.10</td>
</tr>
</tbody>
</table>
<p>PE1 and PE2 run OSPF and exchange BGP routes over an IBGP session.</p>
<h2 id="start-the-lab">Start the Lab</h2>
<p>Assuming you already <a href="../../1-setup/">set up your lab infrastructure</a>:</p>
<ul>
<li>Change directory to <code>session/1-allowas_in</code></li>
<li>Execute <strong>netlab up</strong> (<a href="#req">device requirements</a>, <a href="../../external/">other options</a>)</li>
<li>Log into your devices (CE1, CE2) with <strong>netlab connect</strong> and verify that they have established EBGP sessions with the PE routers.</li>
</ul>
<p><strong>Note:</strong> <em>netlab</em> will configure IP addressing, BGP sessions, and BGP prefix advertisements on all routers. It will also configure OSPF between PE1 and PE2. You must manually configure your routers if you&rsquo;re not using <em>netlab</em>.</p>
<h2 id="the-problem">The Problem</h2>
<p>Assuming your routers are configured correctly, you should see the local loopback address in the BGP table. For example, this is how the BGP table looks on CE1 running Arista EOS:</p>
<pre><code>ce1&gt;show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.0.1/32            -                     -       -          -       0       i
</code></pre>
<p>The loopback prefixes are propagated to the PE-routers and are visible in their BGP tables:</p>
<pre><code>$ netlab connect pe1 --show ip bgp
Connecting to container clab-allowas-pe1, executing sudo vtysh -c &quot;show ip bgp&quot;
BGP table version is 2, local router ID is 10.0.0.10, vrf id 0
Default local pref 100, local AS 65100
Status codes:  s suppressed, d damped, h history, * valid, &gt; best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop's vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 10.0.0.1/32      10.1.0.1                               0 65000 i
*&gt;i10.0.0.2/32      10.0.0.11                     100      0 65000 i
</code></pre>
<p>However, the loopback prefix of CE2 is not visible on CE1 and vice versa. It&rsquo;s time for a troubleshooting session.</p>
<h3 id="why-are-the-loopback-prefixes-not-propagated">Why Are the Loopback Prefixes Not Propagated?</h3>
<p>It&rsquo;s relatively easy to find out what&rsquo;s wrong on platforms supporting debugging of BGP updates. This is a printout you&rsquo;d get on CE1 running Cisco IOS after enabling BGP update debugging<sup id="fnref:NDD"><a class="footnote-ref" href="#fn:NDD">2</a></sup> and clearing the EBGP session:</p>
<pre><code>ce1#debug ip bgp updates
BGP updates debugging is on for address family: IPv4 Unicast
ce1#clear ip bgp *
ce1#
%BGP-3-NOTIFICATION_MANY: sent to 1 sessions 6/4 (Administrative Reset) for all peers
%BGP-5-ADJCHANGE: neighbor 10.1.0.2 Down User reset
%BGP_SESSION-5-ADJCHANGE: neighbor 10.1.0.2 IPv4 Unicast topology base removed from session  User reset
%BGP-5-ADJCHANGE: neighbor 10.1.0.2 Up
BGP(0): 10.1.0.2 rcv UPDATE w/ attr: nexthop 10.1.0.2, origin i, originator 0.0.0.0, merged path 65100 65000, AS_PATH , community , extended community , SSA attribute
*Dec 11 08:18:35.013: BGP(0): 10.1.0.2 rcv UPDATE about 10.0.0.2/32 -- DENIED due to: AS-PATH contains our own AS;
</code></pre>
<p>The debugging printouts are unambiguous: the incoming update contains the local AS number in the AS path. BGP loop prevention logic kicks in, and the update is dropped.</p>
<p>You&rsquo;d have a tough time figuring out what&rsquo;s wrong if your device does not support BGP update debugging. For example, the only hint you&rsquo;d get on Arista EOS<sup id="fnref:TDD"><a class="footnote-ref" href="#fn:TDD">3</a></sup> is hidden deep within the <strong>show ip bgp neighbor</strong> printout:</p>
<pre><code>ce1&gt;show ip bgp neighbor
BGP neighbor is 10.1.0.2, remote AS 65100, external link
 Description: pe1
  BGP version 4, remote router ID 10.0.0.10, VRF default
  Last read 00:00:01, last write 00:00:01
  Hold time is 9, keepalive interval is 3 seconds

... skipped tons of irrelevant information ...

  Prefix Statistics:
                                   Sent      Rcvd     Best Paths     Best ECMP Paths
    IPv4 Unicast:                     1         0              0                   0
    IPv6 Unicast:                     0         0              0                   0
  Configured maximum total number of routes is 256000, warning limit is 204800
  Inbound updates dropped by reason:
    AS path loop detection: 2
</code></pre>
<p>Now that we&rsquo;ve identified the problem, let&rsquo;s deploy a kludge to fix it.</p>
<h2 id="configuration-task">Configuration Task</h2>
<p>Most BGP implementations have a nerd knob that disables the BGP AS-path-based loop prevention logic. It&rsquo;s usually configured on individual BGP sessions (per neighbor) with a command similar to <strong>neighbor allowas-in</strong>.</p>
<ul>
<li>Disable the BGP loop prevention logic on CE1 and CE2</li>
<li>Refresh the BGP tables on CE1 and CE2. You can either clear the EBGP sessions with the PE routers or perform a route refresh with a command similar to <strong>clear ip bgp soft in</strong> </li>
</ul>
<h2 id="ver">Verification</h2>
<p>You can use the <strong>netlab validate</strong> command if you&rsquo;ve installed <em>netlab</em> release 1.8.3 or later and use Cumulus Linux, FRR, or Arista EOS on your devices. You&rsquo;ll get this printout if you configure <strong>allowas-in</strong> on CE1 but not CE2.</p>
<p><img alt="" src="../session-allowas-validate.png" /></p>
<p>If that command fails or you&rsquo;re using another network operating system on your devices, check the BGP tables on CE1 and CE2 and verify that they contain both loopback prefixes. This is the printout you could get on Arista EOS:</p>
<pre><code>ce1#show ip bgp
BGP routing table information for VRF default
Router identifier 10.0.0.1, local AS number 65000
Route status codes: s - suppressed contributor, * - valid, &gt; - active, E - ECMP head, e - ECMP
                    S - Stale, c - Contributing to ECMP, b - backup, L - labeled-unicast
                    % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI Origin Validation codes: V - valid, I - invalid, U - unknown
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      10.0.0.1/32            -                     -       -          -       0       i
 *        10.0.0.1/32            10.1.0.2              0       -          100     0       65100 65000 i
 * &gt;      10.0.0.2/32            10.1.0.2              0       -          100     0       65100 65000 i
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The PE routers might send the prefix advertised by a CE router back to that same CE router (the behavior is probably implementation-dependent), in which case you will see two paths to the local loopback prefix.</p>
</div>
<p><strong>Next</strong>: <a href="../2-asoverride/">Fix AS-Path in Environments Reusing BGP AS Numbers</a>.</p>
<h2 id="reference-information">Reference Information</h2>
<p>This lab uses the <a href="../../external/4-router/">4-router lab topology</a>. The following information might help you if you plan to build custom lab infrastructure:</p>
<h3 id="req">Device Requirements</h3>
<ul>
<li>Customer routers: use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP configuration module</a>.</li>
<li>Provider routers: use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP and OSPF configuration modules</a>.</li>
<li>You can perform automated lab validation with Arista EOS, Cumulus Linux, or FRR running on the customer routers. Automated lab validation requires <em>netlab</em> release 1.8.3 or higher.</li>
<li>Git repository contains initial provider routers&rsquo; device configurations for Cumulus Linux.</li>
</ul>
<h3 id="lab-wiring">Lab Wiring</h3>
<table>
<thead>
<tr>
<th>Link Name</th>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td>Site_A-to-ISP</td>
<td>ce1</td>
<td>Ethernet1</td>
<td>pe1</td>
<td>swp1</td>
</tr>
<tr>
<td>Unused link</td>
<td>ce1</td>
<td>Ethernet2</td>
<td>pe2</td>
<td>swp1</td>
</tr>
<tr>
<td>Intra-ISP link</td>
<td>pe1</td>
<td>swp2</td>
<td>pe2</td>
<td>swp2</td>
</tr>
<tr>
<td>Unused link</td>
<td>ce2</td>
<td>Ethernet1</td>
<td>pe1</td>
<td>swp3</td>
</tr>
<tr>
<td>Site_B-to-ISP</td>
<td>ce2</td>
<td>Ethernet2</td>
<td>pe2</td>
<td>swp3</td>
</tr>
</tbody>
</table>
<h3 id="lab-addressing">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ce1</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;"></td>
<td>Site_A-to-ISP</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td><strong>ce2</strong></td>
<td style="text-align: right;">10.0.0.2/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.9/30</td>
<td style="text-align: right;"></td>
<td>Site_B-to-ISP</td>
</tr>
<tr>
<td><strong>pe1</strong></td>
<td style="text-align: right;">10.0.0.10/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;"></td>
<td>Site_A-to-ISP</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.5/30</td>
<td style="text-align: right;"></td>
<td>Intra-ISP link</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td><strong>pe2</strong></td>
<td style="text-align: right;">10.0.0.11/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.6/30</td>
<td style="text-align: right;"></td>
<td>Intra-ISP link</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;">10.1.0.10/30</td>
<td style="text-align: right;"></td>
<td>Site_B-to-ISP</td>
</tr>
</tbody>
</table>
<div class="footnote">
<hr />
<ol>
<li id="fn:4B">
<p>There are only 1024 unique private AS numbers unless you use 4-byte BGP AS numbers.&#160;<a class="footnote-backref" href="#fnref:4B" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:NDD">
<p>Do not use the <strong>debug ip bgp updates</strong> command on a production router. That&rsquo;s how I disconnected a small country from the global Internet in the 1990s. The only somewhat safe way to use this powerful tool is with an access control list (ACL) that selects only the few prefixes you&rsquo;re interested in.&#160;<a class="footnote-backref" href="#fnref:NDD" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:TDD">
<p>According to their Basic BGP Troubleshooting documentation&#160;<a class="footnote-backref" href="#fnref:TDD" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2023–2024 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
