<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        <link rel="canonical" href="https://bgplabs.net/policy/8-community-attach/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Attach BGP Communities to Outgoing BGP Updates &#171; BGP Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BGP Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Home</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../2-labs-by-technology/" class="dropdown-item">Labs by BGP Attributes and Technologies</a>
</li>
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../99-about/" class="dropdown-item">About the Project</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Installation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
<li>
    <a href="../../4-codespaces/" class="dropdown-item">Use GitHub Codespaces</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Custom Lab Infrastructure</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../external/" class="dropdown-item">Manual Setup</a>
</li>
            
<li>
    <a href="../../external/4-router/" class="dropdown-item">Small (4-Router) Lab Topology</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Deploy BGP</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../basic/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Setting Up BGP</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/0-frrouting/" class="dropdown-item">Configuring Cumulus Linux and FRRouting</a>
</li>
            
<li>
    <a href="../../basic/1-session/" class="dropdown-item">Configure a Single EBGP Session</a>
</li>
            
<li>
    <a href="../../basic/2-multihomed/" class="dropdown-item">Configure Multiple EBGP Sessions</a>
</li>
            
<li>
    <a href="../../basic/3-originate/" class="dropdown-item">Advertise IPv4 Prefixes to BGP Neighbors</a>
</li>
            
<li>
    <a href="../../basic/4-ipv6/" class="dropdown-item">Configure BGP for IPv6</a>
</li>
            
<li>
    <a href="../../basic/5-redistribute/" class="dropdown-item">Redistribute IGP Information Into BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Protecting BGP Sessions</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/6-protect/" class="dropdown-item">MD5 Passwords and GTSM</a>
</li>
            
<li>
    <a href="../../basic/9-ao/" class="dropdown-item">TCP Autentication Option (TCP-AO)</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">BGP in Larger Networks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../ibgp/1-edge/" class="dropdown-item">Establish an IBGP Session</a>
</li>
            
<li>
    <a href="../../ibgp/2-transit/" class="dropdown-item">Build a Transit Network with IBGP</a>
</li>
            
<li>
    <a href="../../ibgp/3-rr/" class="dropdown-item">Use BGP Route Reflectors</a>
</li>
            
<li>
    <a href="../../session/6-templates/" class="dropdown-item">BGP Session Templates</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
            
<li>
    <a href="../../session/9-dynamic/" class="dropdown-item">Dynamic BGP Peers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Manipulate AS Path</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../session/1-allowas_in/" class="dropdown-item">Reuse a BGP AS Number Across Multiple Sites</a>
</li>
            
<li>
    <a href="../../session/2-asoverride/" class="dropdown-item">Fix AS-Path in Environments Reusing BGP AS Numbers</a>
</li>
            
<li>
    <a href="../../session/3-localas/" class="dropdown-item">Use Multiple AS Numbers on the Same Router</a>
</li>
            
<li>
    <a href="../../session/4-removeprivate/" class="dropdown-item">Remove Private BGP AS Numbers from the AS Path</a>
</li>
            
<li>
    <a href="../../session/5-routeserver/" class="dropdown-item">BGP Route Server in an Internet Exchange Point</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Load Balancing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lb/1-ebgp/" class="dropdown-item">Load Balancing across External BGP Paths</a>
</li>
            
<li>
    <a href="../../lb/2-dmz-bw/" class="dropdown-item">EBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/3-ibgp/" class="dropdown-item">IBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/4-ibgp-add-path/" class="dropdown-item">IBGP Load Balancing with BGP Additional Paths</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Other Useful Topics</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/7-bfd/" class="dropdown-item">Use BGP Timers and BFD to Speed Up BGP Convergence</a>
</li>
            
<li>
    <a href="../../basic/8-aggregate/" class="dropdown-item">BGP Route Aggregation</a>
</li>
            
<li>
    <a href="../../basic/c-default-route/" class="dropdown-item">Advertise Default Route in BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
            
<li>
    <a href="../../basic/e-ebgp-multihop/" class="dropdown-item">Running EBGP Across a Firewall</a>
</li>
            
<li>
    <a href="../../session/8-passive/" class="dropdown-item">Passive BGP Sessions</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Routing Policies</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Route Filters</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../2-stop-transit/" class="dropdown-item">Filter Transit Routes</a>
</li>
            
<li>
    <a href="../3-prefix/" class="dropdown-item">Filter Advertised Prefixes</a>
</li>
            
<li>
    <a href="../4-reduce/" class="dropdown-item">Minimize the Size of Your BGP Table</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
            
<li>
    <a href="../d-no-export/" class="dropdown-item">Using No-Export Community to Filter Transit Routes</a>
</li>
            
<li>
    <a href="../f-orf/" class="dropdown-item">Use Outbound Route Filters (ORF) for IP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Outgoing (Egress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../1-weights/" class="dropdown-item">Select Preferred EBGP Peer with Weights</a>
</li>
            
<li>
    <a href="../5-local-preference/" class="dropdown-item">Select Preferred Uplink with BGP Local Preference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Incoming (Ingress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../6-med/" class="dropdown-item">Use MED to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../7-prepend/" class="dropdown-item">Use AS-Path Prepending to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Attach BGP Communities to Outgoing BGP Updates</a>
</li>
            
<li>
    <a href="../e-wedgies/" class="dropdown-item">Resolve BGP Wedgies</a>
</li>
            
<li>
    <a href="../b-disaggregate/" class="dropdown-item">Use Disaggregated Prefixes to Select the Primary Link</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">More Complex Routing Policies</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../9-community-use/" class="dropdown-item">Use BGP Communities in Routing Policies</a>
</li>
            
<li>
    <a href="../a-locpref-route-map/" class="dropdown-item">BGP Local Preference in a Complex Routing Policy</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Challenges</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../challenge/03-graceful-shutdown/" class="dropdown-item">BGP Graceful Shutdown</a>
</li>
                                    
<li>
    <a href="../../challenge/04-block-fat-fingers/" class="dropdown-item">Stop the Propagation of Configuration Errors</a>
</li>
                                    
<li>
    <a href="../../challenge/20-merge-as/" class="dropdown-item">Merge Networks Using Different BGP AS Numbers</a>
</li>
                                    
<li>
    <a href="../../challenge/30-reduce-fib/" class="dropdown-item">Minimize the Forwarding Table on BGP Routers</a>
</li>
                                    
<li>
    <a href="../../challenge/40-mpls-core/" class="dropdown-item">BGP-Free Core in a Transit Network</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Upcoming</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../challenge/01-bird-rr/" class="dropdown-item">Using BIRD BGP Daemon as a BGP Route Reflector</a>
</li>
                                    
<li>
    <a href="../../challenge/02-anycast/" class="dropdown-item">Implement Anycast Services with BGP</a>
</li>
                                    
<li>
    <a href="../../challenge/05-ebgp-dc/" class="dropdown-item">EBGP-Only Data Center Design</a>
</li>
                                    
<li>
    <a href="../../challenge/21-loopback-vrf/" class="dropdown-item">Run EBGP Between VRF Instances on a Single Router</a>
</li>
                                    
<li>
    <a href="../../challenge/22-bgp-ha-protocol/" class="dropdown-item">BGP as a High Availability Protocol</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../7-prepend/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../e-wedgies/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>

                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
  <div class="navbar-header">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
          <span class="fa fa-angle-down"></span>
      </button>
  </div>

  
  
  
  
  
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary"  style="margin-bottom: 1em;">
      <ul class="nav flex-column">
          
      <li class="nav-item" data-level="1"><a href="#attach-bgp-communities-to-outgoing-bgp-updates" class="nav-link">Attach BGP Communities to Outgoing BGP Updates</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="2"><a href="#initial-router-configurations" class="nav-link">Initial Router Configurations</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#start-the-lab" class="nav-link">Start the Lab</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#default-traffic-flow" class="nav-link">Default Traffic Flow</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#configure-as-path-prepending" class="nav-link">Configure AS Path Prepending</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#bgp-communities-to-the-rescue" class="nav-link">BGP Communities to the Rescue</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#verification" class="nav-link">Verification</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#req" class="nav-link">Device Requirements</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-wiring" class="nav-link">Lab Wiring</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-addressing" class="nav-link">Lab Addressing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
        </ul>
      </li>
      </ul>
    </div>
  
  
  
  
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="attach-bgp-communities-to-outgoing-bgp-updates">Attach BGP Communities to Outgoing BGP Updates</h1>
<p>In previous lab exercises, you figured out how to nudge an adjacent network to prefer one of the links with the <a href="../6-med/">Multi-Exit Discriminator attribute</a>, and how to push a bit harder with <a href="../7-prepend/">AS path prepending</a>. Sometimes, more than that is needed, and in this lab exercise, you&rsquo;ll have to deal with a scenario in which a Service Provider routing policy interferes strongly with your intentions.</p>
<p>You have two sites. One is connected to two Service Providers (ISP-1 and ISP-2), and the other has only one uplink (to ISP-2). The link from Site-1 to ISP-1 is significantly faster than the alternate link, and you&rsquo;d like to use it exclusively. The traffic from Site-2 to Site-1 should therefore flow through ISP-2 and ISP-1 (C2→X2→X1→C1)</p>
<p>In this lab, you&rsquo;ll try to influence the Service Provider route selection with AS path prepending and use BGP communities to tell them what changes you&rsquo;d like them to make to their routing policy.</p>
<p><img alt="Lab topology" src="../topology-community-attach.png" /></p>
<h2 id="initial-router-configurations">Initial Router Configurations</h2>
<p>The routers in your lab use the following BGP AS numbers. Each autonomous system advertises an IPv4 prefix.</p>
<table>
<thead>
<tr>
<th>Node/ASN</th>
<th style="text-align: right;">Router ID</th>
<th style="text-align: right;">Advertised prefixes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AS65000</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>c1</td>
<td style="text-align: right;">10.0.0.1</td>
<td style="text-align: right;">192.168.42.0/24</td>
</tr>
<tr>
<td><strong>AS65001</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>c2</td>
<td style="text-align: right;">10.0.0.2</td>
<td style="text-align: right;">192.168.37.0/24</td>
</tr>
<tr>
<td><strong>AS65207</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>x1</td>
<td style="text-align: right;">10.0.0.10</td>
<td style="text-align: right;">172.17.207.0/24</td>
</tr>
<tr>
<td><strong>AS65304</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>x2</td>
<td style="text-align: right;">10.0.0.11</td>
<td style="text-align: right;">172.23.4.0/24</td>
</tr>
</tbody>
</table>
<p>Your routers have these BGP neighbors:</p>
<table>
<thead>
<tr>
<th>Node</th>
<th>Router ID /<br />Neighbor</th>
<th style="text-align: right;">Router AS/<br />Neighbor AS</th>
<th style="text-align: right;">Neighbor IPv4</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>c1</strong></td>
<td>10.0.0.1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>x1</td>
<td style="text-align: right;">65207</td>
<td style="text-align: right;">10.1.0.2</td>
</tr>
<tr>
<td></td>
<td>x2</td>
<td style="text-align: right;">65304</td>
<td style="text-align: right;">10.1.0.6</td>
</tr>
<tr>
<td><strong>c2</strong></td>
<td>10.0.0.2</td>
<td style="text-align: right;">65001</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>x2</td>
<td style="text-align: right;">65304</td>
<td style="text-align: right;">10.1.0.14</td>
</tr>
</tbody>
</table>
<h2 id="start-the-lab">Start the Lab</h2>
<p>Assuming you already <a href="../../1-setup/">set up your lab infrastructure</a>:</p>
<ul>
<li>Change directory to <code>policy/8-community-attach</code></li>
<li>Execute <strong>netlab up</strong> (<a href="#req">device requirements</a>). You can also <a href="../../external/">deploy the lab on some other lab infrastructure</a>.</li>
<li>Log into your devices (C1 and C2) with <strong>netlab connect</strong> and verify their configurations.</li>
</ul>
<p><strong>Note:</strong> <em>netlab</em> will configure IP addressing, BGP, EBGP sessions, and BGP prefix advertisements on your routers. If you&rsquo;re not using <em>netlab</em>, you must configure your routers manually.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This lab requires additional configuration on X2. That configuration is currently available only for Arista EOS, Cumulus Linux, and FRR &ndash; you have to use one of those devices as the external BGP router(s).</p>
</div>
<h2 id="default-traffic-flow">Default Traffic Flow</h2>
<p>After starting the lab, log into C2 and examine its BGP table, looking for prefixes advertised by C1. You should get a printout similar to this one (generated on Arista cEOS)<sup id="fnref:RAI"><a class="footnote-ref" href="#fn:RAI">1</a></sup>:</p>
<pre><code>c2&gt;show ip bgp | include 192.168.42.0
 * &gt;      192.168.42.0/24        10.1.0.14             0       -          100     0       65304 65000 ?
</code></pre>
<p>As you can see, X2 decided to reach AS 65100 over the direct link. Let&rsquo;s fix that with AS path prepending.</p>
<h2 id="configure-as-path-prepending">Configure AS Path Prepending</h2>
<p>X2 might select the path through X1 as the best path toward Site-1 (AS 65100) if you inject enough copies of your AS number into the BGP updates C1 sends to X2. Following the procedure outlined in the <em><a href="../7-prepend/">Use AS-Path Prepending to Influence Incoming Traffic Flow</a></em> exercise, extend the AS path of the prefixes C1 sends to X2. If that doesn&rsquo;t work, prepend more copies of your AS to the AS path.</p>
<p>Eventually, you&rsquo;ll figure out that no amount of prepending fixes the problem. X2 stubbornly uses the direct path to Site-1 (X2-C1) even if you prepend many copies of <code>65000</code> to the AS path. Here&rsquo;s the relevant printout from C2:</p>
<pre><code>c2&gt;show ip bgp | include 192.168.42.0
 * &gt;      192.168.42.0/24        10.1.0.14             0       -          100     0       65304 65000 65000 65000 65000 65000 65000 65000 65000 ?
</code></pre>
<h2 id="bgp-communities-to-the-rescue">BGP Communities to the Rescue</h2>
<p>It&rsquo;s time to give up and give ISP-2 a call. After enjoying the <em>on-hold</em> music for too long and going through too many escalation steps, you might find someone who understands what you&rsquo;re trying to do, pointing you to an online document describing how ISP-2 uses BGP communities. That document might contain a description along these lines<sup id="fnref:BCD"><a class="footnote-ref" href="#fn:BCD">2</a></sup>:</p>
<hr />
<p>All customer routes received by ISP-2 are assigned a local preference 200. Customers can alter this local preference using the following BGP communities:</p>
<table>
<thead>
<tr>
<th>Community</th>
<th style="text-align: right;">Local Pref</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td>65304:102</td>
<td style="text-align: right;">190</td>
<td>Used for customer backup when multi-homed to ISP-2</td>
</tr>
<tr>
<td>65304:101</td>
<td style="text-align: right;">100</td>
<td>Sets local preference equal to transit routes</td>
</tr>
<tr>
<td>65304:100</td>
<td style="text-align: right;">50</td>
<td>Lowest possible value. Used for backup when multi-homed to multiple providers</td>
</tr>
</tbody>
</table>
<hr />
<p>It looks like your woes could be fixed by using community 65304:100. Here&rsquo;s what you have to do:</p>
<ul>
<li>You already created a routing policy on C1 to implement AS path prepending. If you skipped that step, create a new routing policy (often called a <strong>route map</strong>) on C1. You have already used routing policies in <a href="../">previous lab exercises</a> and should be familiar with them.</li>
<li>In the routing policy, set the BGP community to <code>65304:100</code></li>
<li>Attach the routing policy to outgoing updates C1 sends to X2.</li>
<li>If needed, configure BGP community propagation on C1 with a BGP configuration command similar to <strong>neighbor <em>address</em> send-community</strong>.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul>
<li>Many BGP implementations strip BGP communities from outgoing BGP updates by default. Your routing policy might be perfect, but it will only affect the EBGP updates if you configure BGP community propagation. Even worse, if you use a command like <strong>show ip bgp neighbor <em>address</em> advertised-routes <em>prefix</em></strong>, it might not show the BGP community<sup id="fnref:DWA"><a class="footnote-ref" href="#fn:DWA">3</a></sup>, leading you to the conclusion that your routing policy might be broken.</li>
<li>Applying routing policy parameters to BGP neighbors doesn&rsquo;t necessarily change the BGP table, as the new routing policy might be evaluated only on new incoming updates. You might have to use a command similar to <code>clear ip bgp * soft</code> to tell your router to resend BGP updates to its neighbors.</li>
</ul>
</div>
<h2 id="verification">Verification</h2>
<p>You can use the <strong>netlab validate</strong> command if you&rsquo;ve installed <em>netlab</em> release 1.8.3 or later and use Cumulus Linux, FRR, or Arista EOS on X1 and X2. The validation tests check:</p>
<ul>
<li>The state of the EBGP session between RTR and X1/X2.</li>
<li>Whether C1 is advertising its IPv4 prefix</li>
<li>Whether C1 attaches the expected community to the EBGP update sent to X2</li>
<li>Whether X2 lowers the local preference of EBGP path advertised by C1</li>
<li>Whether X2 prefers the transit path (X2-X1-C1) over the direct path (X2-C1).</li>
</ul>
<p>This is the printout you should get after completing the lab exercise:</p>
<p><a href="../policy-c-attach-validate.png"><img alt="" src="../policy-c-attach-validate.png" /></a></p>
<p>You can also reexamine the BGP table on C2. If you did everything right, you&rsquo;d see that X2 changed its mind and now advertises the path through X1 (AS 65207) as the best path:</p>
<pre><code>c2&gt;show ip bgp | include 192.168.42.0
 * &gt;      192.168.42.0/24        10.1.0.14             0       -          100     0       65304 65207 65000 ?
</code></pre>
<p>Want to know how the magic works behind the scenes? Log into X2 and inspect its BGP table. This is how you would do it on Cumulus Linux<sup id="fnref:GHU"><a class="footnote-ref" href="#fn:GHU">4</a></sup> (this command also comes in handy if you did something wrong and have to figure out what&rsquo;s going on):</p>
<pre><code>$ netlab connect x2 vtysh -c 'show ip bgp 192.168.42.0'
Connecting to container clab-a_community-x2, executing vtysh -c &quot;show ip bgp 192.168.42.0&quot;
BGP routing table entry for 192.168.42.0/24
Paths: (2 available, best #2, table default)
  Advertised to non peer-group peers:
  10.1.0.5 x1(10.1.0.9) 10.1.0.13
  65000 65000 65000 65000 65000 65000 65000 65000
    10.1.0.5 from 10.1.0.5 (10.0.0.1)
      Origin incomplete, localpref 50, valid, external, bestpath-from-AS 65000
      Community: 65304:100
      Last update: Sat Nov 11 08:42:42 2023
  65207 65000
    10.1.0.9 from x1(10.1.0.9) (10.0.0.10)
      Origin incomplete, valid, external, bestpath-from-AS 65207, best (Local Pref)
      Last update: Sat Nov 11 08:41:49 2023
</code></pre>
<p><strong>Next:</strong> </p>
<ul>
<li><a href="../d-no-export/">Use No-Export Community to Filter Transit Routes</a></li>
<li><a href="../9-community-use/">Use BGP Communities in Routing Policies</a></li>
<li><a href="../e-wedgies/">Resolve BGP Wedgies</a></li>
</ul>
<h2 id="reference-information">Reference Information</h2>
<p>This lab uses the <a href="../../external/4-router/">4-router lab topology</a>. Some links are unused to retain the interface names from that topology.</p>
<p>The following information might help you if you plan to build custom lab infrastructure:</p>
<h3 id="req">Device Requirements</h3>
<ul>
<li>Customer routers: use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP configuration modules</a>.</li>
<li>External routers: while you can use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP configuration modules</a>, X2 requires additional configuration that is only available for Arista EOS, Cumulus Linux, and FRR.</li>
<li>You can do automated lab validation with Arista EOS, Cumulus Linux, or FRR running on external routers. Automated lab validation requires <em>netlab</em> release 1.8.3 or higher.</li>
<li>Git repository contains external router initial device configurations for Cumulus Linux.</li>
</ul>
<h3 id="lab-wiring">Lab Wiring</h3>
<table>
<thead>
<tr>
<th>Link Name</th>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td>Primary uplink</td>
<td>c1</td>
<td>Ethernet1</td>
<td>x1</td>
<td>swp1</td>
</tr>
<tr>
<td>Backup uplink</td>
<td>c1</td>
<td>Ethernet2</td>
<td>x2</td>
<td>swp1</td>
</tr>
<tr>
<td>Inter-ISP link</td>
<td>x1</td>
<td>swp2</td>
<td>x2</td>
<td>swp2</td>
</tr>
<tr>
<td>Unused link</td>
<td>c2</td>
<td>Ethernet1</td>
<td>x1</td>
<td>swp3</td>
</tr>
<tr>
<td>Site 2, uplink 2</td>
<td>c2</td>
<td>Ethernet2</td>
<td>x2</td>
<td>swp3</td>
</tr>
</tbody>
</table>
<h3 id="lab-addressing">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>c1</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;"></td>
<td>Primary uplink</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.5/30</td>
<td style="text-align: right;"></td>
<td>Backup uplink</td>
</tr>
<tr>
<td><strong>c2</strong></td>
<td style="text-align: right;">10.0.0.2/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.13/30</td>
<td style="text-align: right;"></td>
<td>Site 2 uplink</td>
</tr>
<tr>
<td><strong>x1</strong></td>
<td style="text-align: right;">172.17.207.1/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;"></td>
<td>Primary uplink</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.9/30</td>
<td style="text-align: right;"></td>
<td>Inter-ISP link</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td><strong>x2</strong></td>
<td style="text-align: right;">172.23.4.1/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.6/30</td>
<td style="text-align: right;"></td>
<td>Backup uplink</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.10/30</td>
<td style="text-align: right;"></td>
<td>Inter-ISP link</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;">10.1.0.14/30</td>
<td style="text-align: right;"></td>
<td>Site 2 uplink</td>
</tr>
</tbody>
</table>
<div class="footnote">
<hr />
<ol>
<li id="fn:RAI">
<p>I&rsquo;m using the concise printout of the BGP table (<strong>show ip bgp</strong>) with an output filter to reduce the amount of information you have to sift through. You could also use a command similar to <strong>show ip bgp 192.168.42.0</strong>&#160;<a class="footnote-backref" href="#fnref:RAI" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:BCD">
<p>Based on <a href="https://onestep.net/communities/as7922/">an actual ISP document</a>&#160;<a class="footnote-backref" href="#fnref:BCD" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:DWA">
<p>Details are implementation-dependent. I observed this behavior on Arista EOS.&#160;<a class="footnote-backref" href="#fnref:DWA" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:GHU">
<p>You should also inspect the configuration of X2 to get some hints for one of the upcoming lab exercises.&#160;<a class="footnote-backref" href="#fnref:GHU" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2023–2025 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
