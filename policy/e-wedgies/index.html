<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        <link rel="canonical" href="https://bgplabs.net/policy/e-wedgies/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Resolve BGP Wedgies &#171; BGP Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BGP Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Home</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../2-labs-by-technology/" class="dropdown-item">Labs by BGP Attributes and Technologies</a>
</li>
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../99-about/" class="dropdown-item">About the Project</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Installation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
<li>
    <a href="../../4-codespaces/" class="dropdown-item">Use GitHub Codespaces</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Custom Lab Infrastructure</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../external/" class="dropdown-item">Manual Setup</a>
</li>
            
<li>
    <a href="../../external/4-router/" class="dropdown-item">Small (4-Router) Lab Topology</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Deploy BGP</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../basic/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Setting Up BGP</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/0-frrouting/" class="dropdown-item">Configuring Cumulus Linux and FRRouting</a>
</li>
            
<li>
    <a href="../../basic/1-session/" class="dropdown-item">Configure a Single EBGP Session</a>
</li>
            
<li>
    <a href="../../basic/2-multihomed/" class="dropdown-item">Configure Multiple EBGP Sessions</a>
</li>
            
<li>
    <a href="../../basic/3-originate/" class="dropdown-item">Advertise IPv4 Prefixes to BGP Neighbors</a>
</li>
            
<li>
    <a href="../../basic/4-ipv6/" class="dropdown-item">Configure BGP for IPv6</a>
</li>
            
<li>
    <a href="../../basic/5-redistribute/" class="dropdown-item">Redistribute IGP Information Into BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Protecting BGP Sessions</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/6-protect/" class="dropdown-item">MD5 Passwords and GTSM</a>
</li>
            
<li>
    <a href="../../basic/9-ao/" class="dropdown-item">TCP Autentication Option (TCP-AO)</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">BGP in Larger Networks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../ibgp/1-edge/" class="dropdown-item">Establish an IBGP Session</a>
</li>
            
<li>
    <a href="../../ibgp/2-transit/" class="dropdown-item">Build a Transit Network with IBGP</a>
</li>
            
<li>
    <a href="../../ibgp/3-rr/" class="dropdown-item">Use BGP Route Reflectors</a>
</li>
            
<li>
    <a href="../../session/6-templates/" class="dropdown-item">BGP Session Templates</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
            
<li>
    <a href="../../session/9-dynamic/" class="dropdown-item">Dynamic BGP Peers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Manipulate AS Path</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../session/1-allowas_in/" class="dropdown-item">Reuse a BGP AS Number Across Multiple Sites</a>
</li>
            
<li>
    <a href="../../session/2-asoverride/" class="dropdown-item">Fix AS-Path in Environments Reusing BGP AS Numbers</a>
</li>
            
<li>
    <a href="../../session/3-localas/" class="dropdown-item">Use Multiple AS Numbers on the Same Router</a>
</li>
            
<li>
    <a href="../../session/4-removeprivate/" class="dropdown-item">Remove Private BGP AS Numbers from the AS Path</a>
</li>
            
<li>
    <a href="../../session/5-routeserver/" class="dropdown-item">BGP Route Server in an Internet Exchange Point</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Load Balancing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lb/1-ebgp/" class="dropdown-item">Load Balancing across External BGP Paths</a>
</li>
            
<li>
    <a href="../../lb/2-dmz-bw/" class="dropdown-item">EBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/3-ibgp/" class="dropdown-item">IBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/4-ibgp-add-path/" class="dropdown-item">IBGP Load Balancing with BGP Additional Paths</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Other Useful Topics</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/7-bfd/" class="dropdown-item">Use BGP Timers and BFD to Speed Up BGP Convergence</a>
</li>
            
<li>
    <a href="../../basic/8-aggregate/" class="dropdown-item">BGP Route Aggregation</a>
</li>
            
<li>
    <a href="../../basic/c-default-route/" class="dropdown-item">Advertise Default Route in BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
            
<li>
    <a href="../../basic/e-ebgp-multihop/" class="dropdown-item">Running EBGP Across a Firewall</a>
</li>
            
<li>
    <a href="../../session/8-passive/" class="dropdown-item">Passive BGP Sessions</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Routing Policies</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Route Filters</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../2-stop-transit/" class="dropdown-item">Filter Transit Routes</a>
</li>
            
<li>
    <a href="../3-prefix/" class="dropdown-item">Filter Advertised Prefixes</a>
</li>
            
<li>
    <a href="../4-reduce/" class="dropdown-item">Minimize the Size of Your BGP Table</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
            
<li>
    <a href="../d-no-export/" class="dropdown-item">Using No-Export Community to Filter Transit Routes</a>
</li>
            
<li>
    <a href="../f-orf/" class="dropdown-item">Use Outbound Route Filters (ORF) for IP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Outgoing (Egress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../1-weights/" class="dropdown-item">Select Preferred EBGP Peer with Weights</a>
</li>
            
<li>
    <a href="../5-local-preference/" class="dropdown-item">Select Preferred Uplink with BGP Local Preference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Incoming (Ingress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../6-med/" class="dropdown-item">Use MED to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../7-prepend/" class="dropdown-item">Use AS-Path Prepending to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../8-community-attach/" class="dropdown-item">Attach BGP Communities to Outgoing BGP Updates</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Resolve BGP Wedgies</a>
</li>
            
<li>
    <a href="../b-disaggregate/" class="dropdown-item">Use Disaggregated Prefixes to Select the Primary Link</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">More Complex Routing Policies</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../9-community-use/" class="dropdown-item">Use BGP Communities in Routing Policies</a>
</li>
            
<li>
    <a href="../a-locpref-route-map/" class="dropdown-item">BGP Local Preference in a Complex Routing Policy</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Challenges</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../challenge/03-graceful-shutdown/" class="dropdown-item">BGP Graceful Shutdown</a>
</li>
                                    
<li>
    <a href="../../challenge/04-block-fat-fingers/" class="dropdown-item">Stop the Propagation of Configuration Errors</a>
</li>
                                    
<li>
    <a href="../../challenge/20-merge-as/" class="dropdown-item">Merge Networks Using Different BGP AS Numbers</a>
</li>
                                    
<li>
    <a href="../../challenge/30-reduce-fib/" class="dropdown-item">Minimize the Forwarding Table on BGP Routers</a>
</li>
                                    
<li>
    <a href="../../challenge/40-mpls-core/" class="dropdown-item">BGP-Free Core in a Transit Network</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Upcoming</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../challenge/01-bird-rr/" class="dropdown-item">Using Bird BGP Daemon as a BGP Route Reflector</a>
</li>
                                    
<li>
    <a href="../../challenge/02-anycast/" class="dropdown-item">Implement Anycast Services with BGP</a>
</li>
                                    
<li>
    <a href="../../challenge/05-ebgp-dc/" class="dropdown-item">EBGP-Only Data Center Design</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../8-community-attach/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../b-disaggregate/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>

                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
  <div class="navbar-header">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
          <span class="fa fa-angle-down"></span>
      </button>
  </div>

  
  
  
  
  
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary"  style="margin-bottom: 1em;">
      <ul class="nav flex-column">
          
      <li class="nav-item" data-level="1"><a href="#resolve-bgp-wedgies" class="nav-link">Resolve BGP Wedgies</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="2"><a href="#existing-bgp-configuration" class="nav-link">Existing BGP Configuration</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#bgp-as-numbers" class="nav-link">BGP AS Numbers</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#start-the-lab" class="nav-link">Start the Lab</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#the-problem" class="nav-link">The Problem</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#change-bgp-local-preference-on-p2" class="nav-link">Change BGP Local Preference on P2</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#setting-bgp-community-is-not-enough" class="nav-link">Setting BGP Community Is Not Enough</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#increase-the-as-path-length" class="nav-link">Increase the AS Path Length</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#validate" class="nav-link">Verification</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#req" class="nav-link">Device Requirements</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-wiring" class="nav-link">Lab Wiring</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-addressing" class="nav-link">Lab Addressing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
        </ul>
      </li>
      </ul>
    </div>
  
  
  
  
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="resolve-bgp-wedgies">Resolve BGP Wedgies</h1>
<p>In the <a href="../8-community-attach/">Attach BGP Communities to Outgoing BGP Updates</a> exercise, you&rsquo;ve learned how to use BGP communities to tell Internet Service Providers to reduce BGP local preference on their end because you want to use a connection as a backup link.</p>
<p>Even that&rsquo;s not enough in larger environments, as the global BGP routing system might have more than one stable state, and it might be hard to push the system from the current stable state into the one you prefer. <a href="https://datatracker.ietf.org/doc/html/rfc4264">RFC 4264</a> lovingly calls the unintended stable BGP states <em>BGP Wedgies</em>; you&rsquo;ll explore- and fix them in this lab exercise that uses a pretty standard two-tier ISP topology:</p>
<p><img alt="Lab topology" src="../topology-wedgies.png" /></p>
<h2 id="existing-bgp-configuration">Existing BGP Configuration</h2>
<p>The routers in your lab use the following BGP AS numbers. C1, P1, and P2 advertise an IPv4 prefix.</p>
<h2 id="bgp-as-numbers">BGP AS Numbers</h2>
<table>
<thead>
<tr>
<th>Node/ASN</th>
<th style="text-align: right;">Router ID</th>
<th style="text-align: right;">Advertised prefixes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AS65000</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>c1</td>
<td style="text-align: right;">10.0.0.1</td>
<td style="text-align: right;">192.168.42.0/24</td>
</tr>
<tr>
<td><strong>AS65101</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>u1</td>
<td style="text-align: right;">10.0.0.4</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td><strong>AS65102</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>u2</td>
<td style="text-align: right;">10.0.0.5</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td><strong>AS65207</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>p1</td>
<td style="text-align: right;">172.17.207.1</td>
<td style="text-align: right;">172.17.207.0/24</td>
</tr>
<tr>
<td><strong>AS65304</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>p2</td>
<td style="text-align: right;">172.23.4.1</td>
<td style="text-align: right;">172.23.4.0/24</td>
</tr>
</tbody>
</table>
<p>Your router has these EBGP neighbors.  <em>netlab</em> configures them automatically; if you&rsquo;re using some other lab infrastructure, you&rsquo;ll have to configure EBGP neighbors and advertised prefixes manually.</p>
<table>
<thead>
<tr>
<th>Node</th>
<th>Router ID /<br />Neighbor</th>
<th style="text-align: right;">Router AS/<br />Neighbor AS</th>
<th style="text-align: right;">Neighbor IPv4</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>c1</strong></td>
<td>10.0.0.1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>p1</td>
<td style="text-align: right;">65207</td>
<td style="text-align: right;">10.1.0.2</td>
</tr>
<tr>
<td></td>
<td>p2</td>
<td style="text-align: right;">65304</td>
<td style="text-align: right;">10.1.0.6</td>
</tr>
</tbody>
</table>
<h2 id="start-the-lab">Start the Lab</h2>
<p>Assuming you already <a href="../../1-setup/">set up your lab infrastructure</a>:</p>
<ul>
<li>Change directory to <code>policy/e-wedgies</code></li>
<li>Execute <strong>netlab up</strong> (<a href="#req">device requirements</a>)</li>
<li>Log into your router (RTR) with <strong>netlab connect c1</strong> and verify that the IP addresses and the EBGP sessions are properly configured.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code>netlab connect --show</code> command used in the verification section was introduced in <em>netlab</em> release 1.7.0. Automated lab validation requires <em>netlab</em> release 1.8.3.</p>
</div>
<h2 id="the-problem">The Problem</h2>
<p>Without additional BGP policy configuration, the P2 (upstream ISP) router prefers the direct connection to reach the customer prefix 192.168.42.0/24:</p>
<pre><code>$ netlab connect -q p2 --show ip bgp
BGP table version is 6, local router ID is 172.23.4.1, vrf id 0
Default local pref 100, local AS 65304
Status codes:  s suppressed, d damped, h history, * valid, &gt; best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
Nexthop codes: @NNN nexthop's vrf id, &lt; announce-nh-self
Origin codes:  i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 10.0.0.1/32      10.1.0.5                      200      0 65000 i
*&gt; 172.17.207.0/24  10.1.0.14                              0 65102 65101 65207 i
*&gt; 172.23.4.0/24    0.0.0.0                  0         32768 i
*&gt; 192.168.42.0/24  10.1.0.5                      200      0 65000 ?
</code></pre>
<p>You could try using the AS path prepending to make P2 prefer the alternate path (going through U2, U1, and P1) with a longer AS path, but that wouldn&rsquo;t work. P2 always prefers customer paths over upstream paths and sets a high local preference for paths received from its customers. If you inspect the BGP information for the customer prefix on P2, you&rsquo;ll notice that the local preference is higher than the default 100.</p>
<pre><code>$ netlab connect -q p2 --show ip bgp 192.168.42.0
BGP routing table entry for 192.168.42.0/24
Paths: (1 available, best #1, table default)
  Advertised to non peer-group peers:
  10.1.0.5 u2(10.1.0.14)
  65000
    10.1.0.5 from 10.1.0.5 (10.0.0.1)
      Origin incomplete, localpref 200, valid, external, bestpath-from-AS 65000, best (First path received)
      Last update: Mon Jun 24 11:35:05 2024
</code></pre>
<p>Fortunately, the P2 ISP implemented a BGP community scheme (described in the <a href="../8-community-attach/">Attach BGP Communities to Outgoing BGP Updates</a> lab exercise) that allows you to tell P2 to lower the local preference of your prefix to 50 by attaching BGP community 65304:100 to BGP paths sent in EBGP updates to P2.</p>
<h2 id="change-bgp-local-preference-on-p2">Change BGP Local Preference on P2</h2>
<ul>
<li>Attach the BGP community 65304:100 to all EBGP updates sent from C1 to P2 using the configuration mechanisms you mastered in the <a href="../8-community-attach/">Attach BGP Communities to Outgoing BGP Updates</a> lab exercise.</li>
<li>Execute <strong>show ip bgp</strong> (or similar) command on P2 to confirm the change in BGP local preference. You can also <a href="#validate">use the <strong>netlab validate</strong> command</a>.</li>
</ul>
<h2 id="setting-bgp-community-is-not-enough">Setting BGP Community Is Not Enough</h2>
<p>Even after P2 lowers the local preference of the 192.168.42.0/24 prefix, it does not receive an alternate path (via P1, U1, and U2) because U2 prefers the path through P2 due to its shorter AS path; we&rsquo;re dealing with a BGP wedgie.</p>
<p>You can verify that with the <strong>show ip bgp 192.168.42.0/24</strong> (or similar) command executed on U2 (you can also <a href="#validate">use the <strong>netlab validate</strong> command</a>):</p>
<pre><code>$ netlab connect -q u2 --show ip bgp 192.168.42.0
BGP routing table entry for 192.168.42.0/24
Paths: (2 available, best #2, table default)
  Advertised to non peer-group peers:
  p2(10.1.0.13) u1(10.1.0.17)
  65101 65207 65000
    10.1.0.17 from u1(10.1.0.17) (10.0.0.4)
      Origin incomplete, valid, external, bestpath-from-AS 65101
      Last update: Mon Jun 24 11:35:01 2024
  65304 65000
    10.1.0.13 from p2(10.1.0.13) (172.23.4.1)
      Origin incomplete, valid, external, bestpath-from-AS 65304, best (AS Path)
      Community: 65304:100
      Last update: Mon Jun 24 11:54:14 2024
</code></pre>
<p>Even though you can observe the BGP community 65304:100 attached to the BGP path for 192.168.42.0/24 on U2, U2 does not recognize the community, ignores it, and uses AS-path length as the path selection criterion.</p>
<p>Let&rsquo;s see if we&rsquo;re dealing with a true BGP wedgie:</p>
<ul>
<li>Clear the BGP session between C1 and P2. P2 will send an &ldquo;<em>I lost the prefix</em>&rdquo; update to U2. U2 will select an alternate route and send it to P2. When P2 receives the route from the customer, it will already have an alternate route with a better local preference. The traffic from P2 to C1 will go over U2, U1, and P1.</li>
<li>Clear the BGP session between C1 and P1. P1 will send an &ldquo;<em>I lost the prefix</em>&rdquo; update to U1, U1 will propagate it to U2, and U2 will send it to P2. P2 will have a single path to 192.168.42.0/24 left and will advertise it to U2, flipping the routing system back into the undesired stable state.</li>
</ul>
<h2 id="increase-the-as-path-length">Increase the AS Path Length</h2>
<p>In real life, you could figure out what BGP community to use to influence the BGP best path selection process on U2; we&rsquo;ll use a brute-force approach and prepend a few AS numbers to the AS path C1 advertises to P2.</p>
<p>Prepend at least three copies of your AS number (65000) to the EBGP updates C1 sends to P2. Use the configuration mechanisms you mastered in the <a href="../7-prepend/">Use AS-Path Prepending to Influence Incoming Traffic Flow</a> lab exercise.</p>
<h2 id="validate">Verification</h2>
<p>You can use the <strong>netlab validate</strong> command if you&rsquo;ve installed <em>netlab</em> release 1.8.3 or later and use Cumulus Linux, FRR, or Arista EOS on the external routers. The validation tests check:</p>
<ul>
<li>The state of the EBGP session between C1 and P1/P2</li>
<li>Whether C1 advertises its prefix to P1/P2 and whether that gets propagated to U1/U2.</li>
<li>The community attached to the EBGP updates C1 sends to P2.</li>
<li>Whether the next hop of the best path toward 192.168.42.0/24 on U2 points to U1.</li>
</ul>
<p><img alt="" src="../policy-wedgies-validate.png" /></p>
<p>If the <strong>netlab validate</strong> command fails or you&rsquo;re using another network operating system on the ISP routers:</p>
<ul>
<li>Check the BGP prefix advertised by C1 on P2 with a command similar to <strong>show ip bgp 192.168.42.0/24</strong>. The prefix advertised by C1 should have a long AS path, BGP community 65304:100, and local preference set to 50.</li>
</ul>
<pre><code>$ netlab connect -q p2 --show ip bgp 192.168.42.0
BGP routing table entry for 192.168.42.0/24
Paths: (2 available, best #1, table default)
  Advertised to non peer-group peers:
  10.1.0.5 u2(10.1.0.14)
  65102 65101 65207 65000
    10.1.0.14 from u2(10.1.0.14) (10.0.0.5)
      Origin incomplete, valid, external, bestpath-from-AS 65102, best (Local Pref)
      Last update: Mon Jun 24 11:59:55 2024
  65000 65000 65000 65000 65000 65000 65000 65000
    10.1.0.5 from 10.1.0.5 (10.0.0.1)
      Origin incomplete, localpref 50, valid, external, bestpath-from-AS 65000
      Community: 65304:100
      Last update: Mon Jun 24 11:59:55 2024
</code></pre>
<ul>
<li>Check the same prefix on U2. There should be a single BGP path for that prefix in the U2 BGP table, and it should be advertised by U1:</li>
</ul>
<pre><code>$ netlab connect -q u2 --show ip bgp 192.168.42.0
BGP routing table entry for 192.168.42.0/24
Paths: (1 available, best #1, table default)
  Advertised to non peer-group peers:
  p2(10.1.0.13) u1(10.1.0.17)
  65101 65207 65000
    10.1.0.17 from u1(10.1.0.17) (10.0.0.4)
      Origin incomplete, valid, external, bestpath-from-AS 65101, best (First path received)
      Last update: Mon Jun 24 11:35:00 2024
</code></pre>
<p><strong>Next:</strong> </p>
<ul>
<li><a href="../b-disaggregate/">Use Disaggregated Prefixes to Select the Primary Link</a></li>
</ul>
<h2 id="reference-information">Reference Information</h2>
<p>The following information might help you if you plan to build custom lab infrastructure:</p>
<h3 id="req">Device Requirements</h3>
<ul>
<li>Use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP configuration module</a> for C1, P1, U1, and U2.</li>
<li>P2 requires additional configuration that sets BGP local preference based on BGP communities. The lab exercise includes configuration templates for Arista EOS, Cumulus Linux, and FRR. If you decide to use any other device for P2, you&rsquo;ll have to configure it manually.</li>
<li>You can do automated lab validation with Arista EOS, Cumulus Linux, or FRR running on P1, P2, U1, and U2. Automated lab validation requires <em>netlab</em> release 1.8.3 or higher.</li>
<li>Git repository contains initial device configurations for Cumulus Linux.</li>
</ul>
<h3 id="lab-wiring">Lab Wiring</h3>
<table>
<thead>
<tr>
<th>Link Name</th>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td>Primary uplink</td>
<td>c1</td>
<td>Ethernet1</td>
<td>p1</td>
<td>swp1</td>
</tr>
<tr>
<td>Backup uplink</td>
<td>c1</td>
<td>Ethernet2</td>
<td>p2</td>
<td>swp1</td>
</tr>
<tr>
<td>P1 uplink</td>
<td>p1</td>
<td>swp2</td>
<td>u1</td>
<td>swp1</td>
</tr>
<tr>
<td>P2 uplink</td>
<td>p2</td>
<td>swp2</td>
<td>u2</td>
<td>swp1</td>
</tr>
<tr>
<td>Upstream peering link</td>
<td>u1</td>
<td>swp2</td>
<td>u2</td>
<td>swp2</td>
</tr>
</tbody>
</table>
<h3 id="lab-addressing">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>c1</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;"></td>
<td>Primary uplink</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.5/30</td>
<td style="text-align: right;"></td>
<td>Backup uplink</td>
</tr>
<tr>
<td><strong>p1</strong></td>
<td style="text-align: right;">172.17.207.1/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;"></td>
<td>Primary uplink</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.9/30</td>
<td style="text-align: right;"></td>
<td>P1 uplink</td>
</tr>
<tr>
<td><strong>p2</strong></td>
<td style="text-align: right;">172.23.4.1/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.6/30</td>
<td style="text-align: right;"></td>
<td>Backup uplink</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.13/30</td>
<td style="text-align: right;"></td>
<td>P2 uplink</td>
</tr>
<tr>
<td><strong>u1</strong></td>
<td style="text-align: right;">10.0.0.4/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.10/30</td>
<td style="text-align: right;"></td>
<td>P1 uplink</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.17/30</td>
<td style="text-align: right;"></td>
<td>Upstream peering link</td>
</tr>
<tr>
<td><strong>u2</strong></td>
<td style="text-align: right;">10.0.0.5/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.14/30</td>
<td style="text-align: right;"></td>
<td>P2 uplink</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.18/30</td>
<td style="text-align: right;"></td>
<td>Upstream peering link</td>
</tr>
</tbody>
</table></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2023–2024 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
