<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        <link rel="canonical" href="https://bgplabs.net/policy/a-locpref-route-map/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>BGP Local Preference in a Complex Routing Policy &#171; BGP Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BGP Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Home</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../2-labs-by-technology/" class="dropdown-item">Labs by BGP Attributes and Technologies</a>
</li>
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../99-about/" class="dropdown-item">About the Project</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Installation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
<li>
    <a href="../../4-codespaces/" class="dropdown-item">Use GitHub Codespaces</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Custom Lab Infrastructure</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../external/" class="dropdown-item">Manual Setup</a>
</li>
            
<li>
    <a href="../../external/4-router/" class="dropdown-item">Small (4-Router) Lab Topology</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Deploy BGP</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../basic/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Setting Up BGP</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/0-frrouting/" class="dropdown-item">Configuring Cumulus Linux and FRRouting</a>
</li>
            
<li>
    <a href="../../basic/1-session/" class="dropdown-item">Configure a Single EBGP Session</a>
</li>
            
<li>
    <a href="../../basic/2-multihomed/" class="dropdown-item">Configure Multiple EBGP Sessions</a>
</li>
            
<li>
    <a href="../../basic/3-originate/" class="dropdown-item">Advertise IPv4 Prefixes to BGP Neighbors</a>
</li>
            
<li>
    <a href="../../basic/4-ipv6/" class="dropdown-item">Configure BGP for IPv6</a>
</li>
            
<li>
    <a href="../../basic/5-redistribute/" class="dropdown-item">Redistribute IGP Information Into BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Protecting BGP Sessions</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/6-protect/" class="dropdown-item">MD5 Passwords and GTSM</a>
</li>
            
<li>
    <a href="../../basic/9-ao/" class="dropdown-item">TCP Autentication Option (TCP-AO)</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">BGP in Larger Networks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../ibgp/1-edge/" class="dropdown-item">Establish an IBGP Session</a>
</li>
            
<li>
    <a href="../../ibgp/2-transit/" class="dropdown-item">Build a Transit Network with IBGP</a>
</li>
            
<li>
    <a href="../../ibgp/3-rr/" class="dropdown-item">Use BGP Route Reflectors</a>
</li>
            
<li>
    <a href="../../session/6-templates/" class="dropdown-item">BGP Session Templates</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
            
<li>
    <a href="../../session/9-dynamic/" class="dropdown-item">Dynamic BGP Peers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Manipulate AS Path</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../session/1-allowas_in/" class="dropdown-item">Reuse a BGP AS Number Across Multiple Sites</a>
</li>
            
<li>
    <a href="../../session/2-asoverride/" class="dropdown-item">Fix AS-Path in Environments Reusing BGP AS Numbers</a>
</li>
            
<li>
    <a href="../../session/3-localas/" class="dropdown-item">Use Multiple AS Numbers on the Same Router</a>
</li>
            
<li>
    <a href="../../session/4-removeprivate/" class="dropdown-item">Remove Private BGP AS Numbers from the AS Path</a>
</li>
            
<li>
    <a href="../../session/5-routeserver/" class="dropdown-item">BGP Route Server in an Internet Exchange Point</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Load Balancing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../lb/1-ebgp/" class="dropdown-item">Load Balancing across External BGP Paths</a>
</li>
            
<li>
    <a href="../../lb/2-dmz-bw/" class="dropdown-item">EBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/3-ibgp/" class="dropdown-item">IBGP Load Balancing with BGP Link Bandwidth</a>
</li>
            
<li>
    <a href="../../lb/4-ibgp-add-path/" class="dropdown-item">IBGP Load Balancing with BGP Additional Paths</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Other Useful Topics</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../basic/7-bfd/" class="dropdown-item">Use BGP Timers and BFD to Speed Up BGP Convergence</a>
</li>
            
<li>
    <a href="../../basic/8-aggregate/" class="dropdown-item">BGP Route Aggregation</a>
</li>
            
<li>
    <a href="../../basic/c-default-route/" class="dropdown-item">Advertise Default Route in BGP</a>
</li>
            
<li>
    <a href="../../basic/d-interface/" class="dropdown-item">EBGP Sessions over IPv6 LLA Interfaces</a>
</li>
            
<li>
    <a href="../../basic/e-ebgp-multihop/" class="dropdown-item">Running EBGP Across a Firewall</a>
</li>
            
<li>
    <a href="../../session/8-passive/" class="dropdown-item">Passive BGP Sessions</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Routing Policies</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Route Filters</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../2-stop-transit/" class="dropdown-item">Filter Transit Routes</a>
</li>
            
<li>
    <a href="../3-prefix/" class="dropdown-item">Filter Advertised Prefixes</a>
</li>
            
<li>
    <a href="../4-reduce/" class="dropdown-item">Minimize the Size of Your BGP Table</a>
</li>
            
<li>
    <a href="../../basic/b-max-prefix/" class="dropdown-item">Limit the Number of Accepted BGP Prefixes</a>
</li>
            
<li>
    <a href="../d-no-export/" class="dropdown-item">Using No-Export Community to Filter Transit Routes</a>
</li>
            
<li>
    <a href="../f-orf/" class="dropdown-item">Use Outbound Route Filters (ORF) for IP Prefixes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Outgoing (Egress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../1-weights/" class="dropdown-item">Select Preferred EBGP Peer with Weights</a>
</li>
            
<li>
    <a href="../5-local-preference/" class="dropdown-item">Select Preferred Uplink with BGP Local Preference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Incoming (Ingress) Traffic</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../6-med/" class="dropdown-item">Use MED to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../7-prepend/" class="dropdown-item">Use AS-Path Prepending to Influence Incoming Traffic Flow</a>
</li>
            
<li>
    <a href="../8-community-attach/" class="dropdown-item">Attach BGP Communities to Outgoing BGP Updates</a>
</li>
            
<li>
    <a href="../e-wedgies/" class="dropdown-item">Resolve BGP Wedgies</a>
</li>
            
<li>
    <a href="../b-disaggregate/" class="dropdown-item">Use Disaggregated Prefixes to Select the Primary Link</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">More Complex Routing Policies</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../9-community-use/" class="dropdown-item">Use BGP Communities in Routing Policies</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">BGP Local Preference in a Complex Routing Policy</a>
</li>
            
<li>
    <a href="../../session/7-policy/" class="dropdown-item">BGP Policy Templates</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Challenges</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../challenge/03-graceful-shutdown/" class="dropdown-item">BGP Graceful Shutdown</a>
</li>
                                    
<li>
    <a href="../../challenge/04-block-fat-fingers/" class="dropdown-item">Stop the Propagation of Configuration Errors</a>
</li>
                                    
<li>
    <a href="../../challenge/20-merge-as/" class="dropdown-item">Merge Networks Using Different BGP AS Numbers</a>
</li>
                                    
<li>
    <a href="../../challenge/30-reduce-fib/" class="dropdown-item">Minimize the Forwarding Table on BGP Routers</a>
</li>
                                    
<li>
    <a href="../../challenge/40-mpls-core/" class="dropdown-item">BGP-Free Core in a Transit Network</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Upcoming</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../challenge/01-bird-rr/" class="dropdown-item">Using Bird BGP Daemon as a BGP Route Reflector</a>
</li>
                                    
<li>
    <a href="../../challenge/02-anycast/" class="dropdown-item">Implement Anycast Services with BGP</a>
</li>
                                    
<li>
    <a href="../../challenge/05-ebgp-dc/" class="dropdown-item">EBGP-Only Data Center Design</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../9-community-use/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../session/7-policy/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>

                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
  <div class="navbar-header">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
          <span class="fa fa-angle-down"></span>
      </button>
  </div>

  
  
  
  
  
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary"  style="margin-bottom: 1em;">
      <ul class="nav flex-column">
          
      <li class="nav-item" data-level="1"><a href="#bgp-local-preference-in-a-complex-routing-policy" class="nav-link">BGP Local Preference in a Complex Routing Policy</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="2"><a href="#initial-router-configurations" class="nav-link">Initial Router Configurations</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#external-autonomous-systems" class="nav-link">External Autonomous Systems</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#start-the-lab" class="nav-link">Start the Lab</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#default-outgoing-traffic-flow" class="nav-link">Default Outgoing Traffic Flow</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#implement-complex-routing-policy" class="nav-link">Implement Complex Routing Policy</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#verification" class="nav-link">Verification</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#req" class="nav-link">Device Requirements</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-wiring" class="nav-link">Lab Wiring</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-addressing" class="nav-link">Lab Addressing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
        </ul>
      </li>
      </ul>
    </div>
  
  
  
  
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="bgp-local-preference-in-a-complex-routing-policy">BGP Local Preference in a Complex Routing Policy</h1>
<p>In a previous lab exercise, you <a href="../5-local-preference/">used BGP local preference to prefer a high-speed uplink over a low-speed uplink</a>. That approach works well if you leave the backup link idle while the primary link is operational. Now, imagine that you want to send at least some of the traffic over the backup link that is connected to a different ISP:</p>
<p><img alt="Lab topology" src="../topology-policy-2isp.png" /></p>
<p>In this lab, you&rsquo;ll create a routing policy using BGP local preference to:</p>
<ul>
<li>Send traffic toward prefixes in AS 65101 over the C2-X2 link</li>
<li>Send all other traffic over the C1-X1 link</li>
</ul>
<h2 id="initial-router-configurations">Initial Router Configurations</h2>
<p>The routers in your lab use the following BGP AS numbers. Each autonomous system advertises an IPv4 prefix.</p>
<table>
<thead>
<tr>
<th>Node/ASN</th>
<th style="text-align: right;">Router ID</th>
<th style="text-align: right;">Advertised prefixes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AS65000</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>c1</td>
<td style="text-align: right;">10.0.0.1</td>
<td style="text-align: right;">192.168.42.0/24</td>
</tr>
<tr>
<td>c2</td>
<td style="text-align: right;">10.0.0.2</td>
<td style="text-align: right;">192.168.42.0/24</td>
</tr>
<tr>
<td><strong>AS65100</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>x1</td>
<td style="text-align: right;">10.0.0.10</td>
<td style="text-align: right;">192.168.100.0/24</td>
</tr>
<tr>
<td><strong>AS65101</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>x2</td>
<td style="text-align: right;">10.0.0.11</td>
<td style="text-align: right;">192.168.101.0/24</td>
</tr>
</tbody>
</table>
<p>Your routers have these BGP neighbors:</p>
<table>
<thead>
<tr>
<th>Node</th>
<th>Router ID /<br />Neighbor</th>
<th style="text-align: right;">Router AS/<br />Neighbor AS</th>
<th style="text-align: right;">Neighbor IPv4</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>c1</strong></td>
<td>10.0.0.1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>c2</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;">10.0.0.2</td>
</tr>
<tr>
<td></td>
<td>x1</td>
<td style="text-align: right;">65100</td>
<td style="text-align: right;">10.1.0.2</td>
</tr>
<tr>
<td><strong>c2</strong></td>
<td>10.0.0.2</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>c1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;">10.0.0.1</td>
</tr>
<tr>
<td></td>
<td>x2</td>
<td style="text-align: right;">65101</td>
<td style="text-align: right;">10.1.0.10</td>
</tr>
</tbody>
</table>
<p>Your network is also running OSPF in the backbone area:</p>
<table>
<thead>
<tr>
<th>Router</th>
<th>Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th>Neighbor(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>c1</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.1/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ethernet3</td>
<td style="text-align: right;">192.168.42.1/24</td>
<td>c2</td>
</tr>
<tr>
<td>c2</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.2/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ethernet3</td>
<td style="text-align: right;">192.168.42.2/24</td>
<td>c1</td>
</tr>
</tbody>
</table>
<h2 id="external-autonomous-systems">External Autonomous Systems</h2>
<p>Three other autonomous systems (AS65200, AS65205 and AS65207) are connected to the upstream ISPs:</p>
<p><img alt="External autonomous systems" src="../policy-extra-asn.png" /></p>
<p>The external autonomous systems advertise these prefixes:</p>
<table>
<thead>
<tr>
<th>Node/ASN</th>
<th style="text-align: right;">Router ID</th>
<th style="text-align: right;">Advertised prefixes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AS65200</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>uc200</td>
<td style="text-align: right;">192.168.200.1</td>
<td style="text-align: right;">192.168.200.0/24</td>
</tr>
<tr>
<td><strong>AS65205</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>uc205</td>
<td style="text-align: right;">192.168.205.1</td>
<td style="text-align: right;">192.168.205.0/24</td>
</tr>
<tr>
<td><strong>AS65207</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>uc207</td>
<td style="text-align: right;">192.168.207.1</td>
<td style="text-align: right;">192.168.207.0/24</td>
</tr>
</tbody>
</table>
<p>The virtual lab topology uses three additional devices to implement the external autonomous systems. If your lab environment is low on memory, or if you want to use <a href="../../external/">lab infrastructure that is not managed by <em>netlab</em></a>, you can use the <a href="../../external/4-router/">common 4-router lab topology</a> with Cumulus Linux as the external devices  (additional autonomous systems are emulated during BGP prefix origination on X1 and X2).</p>
<h2 id="start-the-lab">Start the Lab</h2>
<p>Assuming you already <a href="../../1-setup/">set up your lab infrastructure</a>:</p>
<ul>
<li>Change directory to <code>policy/a-locpref-route-map</code></li>
<li>Execute <strong>netlab up</strong> if you have enough memory to start a 7-node lab (<a href="#req">device requirements</a>) or <strong>netlab up topology.4-router.yml</strong> if you want to create a 4-node lab<sup id="fnref:XC"><a class="footnote-ref" href="#fn:XC">1</a></sup>. You can also <a href="../../external/">deploy the lab on your lab infrastructure</a>.</li>
<li>Log into your devices (C1 and C2) with <strong>netlab connect</strong> and verify their configurations.</li>
</ul>
<p><strong>Note:</strong> <em>netlab</em> will configure IP addressing, OSPF, BGP, IBGP sessions, EBGP sessions, and BGP prefix advertisements on your routers. If you&rsquo;re not using <em>netlab</em>, you must manually configure your routers.</p>
<h2 id="default-outgoing-traffic-flow">Default Outgoing Traffic Flow</h2>
<p>After starting the lab, log into C2 and examine its BGP table. You should get a printout similar to this one (generated on Arista cEOS):</p>
<pre><code>c2&gt;show ip bgp | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      0.0.0.0/0              10.1.0.10             0       -          100     0       65101 i
 *        0.0.0.0/0              10.0.0.1              0       -          100     0       65100 i
 * &gt;      192.168.42.0/24        -                     -       -          -       0       i
 *        192.168.42.0/24        10.0.0.1              0       -          100     0       i
 * &gt;      192.168.100.0/24       10.0.0.1              0       -          100     0       65100 i
 *        192.168.100.0/24       10.1.0.10             0       -          100     0       65101 65100 i
 * &gt;      192.168.101.0/24       10.1.0.10             0       -          100     0       65101 i
 * &gt;      192.168.200.0/24       10.0.0.1              0       -          100     0       65100 65200 i
 *        192.168.200.0/24       10.1.0.10             0       -          100     0       65101 65100 65200 i
 * &gt;      192.168.205.0/24       10.1.0.10             0       -          100     0       65101 65205 i
 *        192.168.205.0/24       10.0.0.1              0       -          100     0       65100 65205 i
 * &gt;      192.168.207.0/24       10.1.0.10             0       -          100     0       65101 65207 i
</code></pre>
<p>As you can see, C2 uses the C2-X2 link to reach AS 65100, AS 65205, and AS 65207. It also uses the C2-X2 link to reach unknown destinations (the default route points to X2).</p>
<p>Hint: there&rsquo;s an easier way to find BGP prefixes using the C2-X2 link if your devices support printout filters with regular expressions &ndash; match all lines that include the &lsquo;&gt;&rsquo; character (best route) and 10.1.0.10 (the next hop):</p>
<pre><code>c2&gt;show ip bgp | include &gt;.*10.1.0.10
 * &gt;      0.0.0.0/0              10.1.0.10             0       -          100     0       65101 i
 * &gt;      192.168.101.0/24       10.1.0.10             0       -          100     0       65101 i
 * &gt;      192.168.205.0/24       10.1.0.10             0       -          100     0       65101 65205 i
 * &gt;      192.168.207.0/24       10.1.0.10             0       -          100     0       65101 65207 i
</code></pre>
<h2 id="implement-complex-routing-policy">Implement Complex Routing Policy</h2>
<p>We want to use the C2-X2 link only for the traffic toward destinations in AS65101 &ndash; you will have to create a routing policy on C2 that will:</p>
<ul>
<li>Increase the local preference for BGP prefixes originating in AS 65101 (where the AS path ends with 65101)</li>
<li>Decrease the local preference for the default route &ndash; BGP routers advertise the default route as belonging to their autonomous system</li>
<li>Decrease the local preference for all other BGP prefixes received from AS 65101</li>
</ul>
<p><strong>Hint:</strong> you have probably used routing policies (often called <strong>route maps</strong>) in <a href="../">previous lab exercises</a>. You have also practiced:</p>
<ul>
<li>AS-path filters in the <a href="../2-stop-transit/">Filter Transit Routes</a> exercise</li>
<li>Prefix filters in the <a href="../4-reduce/">Minimize the Size of Your BGP Table</a> exercise</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Applying routing policy parameters to BGP neighbors doesn&rsquo;t necessarily change the BGP table, as the new routing policy might be evaluated only on new incoming updates. You might have to use a command similar to <code>clear ip bgp * soft in</code> to tell your router to ask its neighbors to resend their BGP updates.</p>
</div>
<h2 id="verification">Verification</h2>
<p>Examine the BGP table on C2 to verify the local preference of routes received from X2. You could use the simple <strong>show ip bgp</strong> command and sift through the printout, or use printout filters matching on the next hop (<code>10.1.0.10</code>), or display routes from a specific neighbor (assuming your device supports that)<sup id="fnref:RA"><a class="footnote-ref" href="#fn:RA">2</a></sup>.</p>
<p>The following printout uses the last mechanism on Arista cEOS:</p>
<pre><code>c2#show ip bgp neighbors 10.1.0.10 routes | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 *        0.0.0.0/0              10.1.0.10             0       -          50      0       65101 i
 *        192.168.100.0/24       10.1.0.10             0       -          50      0       65101 65100 i
 * &gt;      192.168.101.0/24       10.1.0.10             0       -          200     0       65101 i
 *        192.168.200.0/24       10.1.0.10             0       -          50      0       65101 65100 65200 i
 *        192.168.205.0/24       10.1.0.10             0       -          50      0       65101 65205 i
 *        192.168.207.0/24       10.1.0.10             0       -          50      0       65101 65207 i
</code></pre>
<p>As you can see:</p>
<ul>
<li>Routes originating in AS 65101 have local preference 200 and are used as the best routes</li>
<li>All other routes advertised by AS 65101 have local preference 50 and are not used.</li>
</ul>
<p>Finally, you should log into C1 and examine routes received from C2. C1 should use C2 only to reach <code>192.168.101/24</code>.</p>
<pre><code>c1&gt;show ip bgp neighbors 10.0.0.2 routes | begin Network
          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 *        192.168.42.0/24        10.0.0.2              0       -          100     0       i
 * &gt;      192.168.101.0/24       10.0.0.2              0       -          200     0       65101 i
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>C2 does not advertise routes it does not use to C1, so you won&rsquo;t be able to see any other routes from the C2 BGP table on C1.</p>
</div>
<h2 id="reference-information">Reference Information</h2>
<h3 id="req">Device Requirements</h3>
<ul>
<li>Customer- and external routers: use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> BGP and OSPF configuration modules</a>.</li>
<li>The 4-router topology requires additional configuration on X1 and X2. That configuration is only available for Arista EOS, Cumulus Linux, and FRR.</li>
<li>Git repository contains external router initial device configurations for Cumulus Linux.</li>
</ul>
<h3 id="lab-wiring">Lab Wiring</h3>
<p>The minimized version of this lab uses a subset of the <a href="../../external/4-router/">4-router lab topology</a>. Some links are unused to retain the interface names from that topology.</p>
<table>
<thead>
<tr>
<th>Link Name</th>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td>Primary uplink</td>
<td>c1</td>
<td>Ethernet1</td>
<td>x1</td>
<td>swp1</td>
</tr>
<tr>
<td>Unused link</td>
<td>c1</td>
<td>Ethernet2</td>
<td>x2</td>
<td>swp1</td>
</tr>
<tr>
<td>Inter-ISP link</td>
<td>x1</td>
<td>swp2</td>
<td>x2</td>
<td>swp2</td>
</tr>
<tr>
<td>Unused link</td>
<td>c2</td>
<td>Ethernet1</td>
<td>x1</td>
<td>swp3</td>
</tr>
<tr>
<td>Backup uplink</td>
<td>c2</td>
<td>Ethernet2</td>
<td>x2</td>
<td>swp3</td>
</tr>
<tr>
<td>Customer internal link</td>
<td>c1</td>
<td>Ethernet3</td>
<td>c2</td>
<td>Ethernet3</td>
</tr>
</tbody>
</table>
<h3 id="lab-addressing">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>c1</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;"></td>
<td>Primary uplink</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>Ethernet3</td>
<td style="text-align: right;">192.168.42.1/24</td>
<td style="text-align: right;"></td>
<td>Customer internal link</td>
</tr>
<tr>
<td><strong>c2</strong></td>
<td style="text-align: right;">10.0.0.2/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.9/30</td>
<td style="text-align: right;"></td>
<td>Backup uplink</td>
</tr>
<tr>
<td>Ethernet3</td>
<td style="text-align: right;">192.168.42.2/24</td>
<td style="text-align: right;"></td>
<td>Customer internal link</td>
</tr>
<tr>
<td><strong>x1</strong></td>
<td style="text-align: right;">192.168.100.1/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;"></td>
<td>Primary uplink</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.5/30</td>
<td style="text-align: right;"></td>
<td>Inter-ISP link</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td><strong>x2</strong></td>
<td style="text-align: right;">192.168.101.1/24</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td>Unused link</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.6/30</td>
<td style="text-align: right;"></td>
<td>Inter-ISP link</td>
</tr>
<tr>
<td>swp3</td>
<td style="text-align: right;">10.1.0.10/30</td>
<td style="text-align: right;"></td>
<td>Backup uplink</td>
</tr>
</tbody>
</table>
<div class="footnote">
<hr />
<ol>
<li id="fn:XC">
<p>The 4-node lab needs additional device configuration on X1 and X2. That configuration is only available for Arista EOS, Cumulus Linux, and FRR.&#160;<a class="footnote-backref" href="#fnref:XC" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:RA">
<p>Some devices (example: Arista cEOS) can display routes <em>received</em> from a neighbor (before being processed by inbound routing policies) and routes <em>received and accepted</em> from a neighbor (after the routing policies). Make sure you use the correct form of the <strong>show</strong> command.&#160;<a class="footnote-backref" href="#fnref:RA" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2023–2024 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
